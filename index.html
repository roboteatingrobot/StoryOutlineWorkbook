<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Story from Start to Finish</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;0,500;0,600;1,400;1,500&family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <style>
/* ============================================
   DESIGN TOKENS
   ============================================ */
:root {
    /* Light theme */
    --bg-app: #f8f7f4;
    --bg-surface: #ffffff;
    --bg-surface-raised: #ffffff;
    --bg-surface-sunken: #f0efe9;
    --bg-surface-hover: #f5f4f0;
    --bg-accent-subtle: #eef4ff;
    --text-primary: #1c1917;
    --text-secondary: #57534e;
    --text-muted: #a8a29e;
    --text-inverse: #ffffff;
    --accent: #3b6df0;
    --accent-hover: #2b55c7;
    --accent-glow: rgba(59, 109, 240, 0.12);
    --accent-text: #2b4faa;
    --border: #e7e5e4;
    --border-subtle: #f0efe9;
    --success: #2d8a4e;
    --success-bg: #ecfdf5;
    --danger: #dc2626;
    --danger-bg: #fef2f2;
    --shadow-xs: 0 1px 2px rgba(28, 25, 23, 0.04);
    --shadow-sm: 0 1px 3px rgba(28, 25, 23, 0.06), 0 1px 2px rgba(28, 25, 23, 0.04);
    --shadow-md: 0 4px 12px rgba(28, 25, 23, 0.08);
    --shadow-lg: 0 12px 40px rgba(28, 25, 23, 0.12);
    --shadow-focus: 0 0 0 3px rgba(59, 109, 240, 0.2);
    --font-display: 'Crimson Pro', Georgia, serif;
    --font-body: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 16px;
    --radius-xl: 24px;
    --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
    --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
    --nav-height: 60px;
    --bottom-nav-height: 0px;
    --safe-area-bottom: env(safe-area-inset-bottom, 0px);
}

@media (prefers-color-scheme: dark) {
    :root {
        --bg-app: #141210;
        --bg-surface: #1e1c19;
        --bg-surface-raised: #262420;
        --bg-surface-sunken: #0f0e0c;
        --bg-surface-hover: #2a2825;
        --bg-accent-subtle: #1a2340;
        --text-primary: #f5f5f4;
        --text-secondary: #a8a29e;
        --text-muted: #6b6560;
        --text-inverse: #1c1917;
        --accent: #6b93f7;
        --accent-hover: #8baaf9;
        --accent-glow: rgba(107, 147, 247, 0.12);
        --accent-text: #8baaf9;
        --border: #2e2c28;
        --border-subtle: #242220;
        --success: #4ade80;
        --success-bg: #0a1f13;
        --danger: #f87171;
        --danger-bg: #2a0f0f;
        --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.2);
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
        --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.4);
    }
}

/* ============================================
   RESET & BASE
   ============================================ */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html { -webkit-text-size-adjust: 100%; scroll-behavior: smooth; }
body {
    font-family: var(--font-body);
    background: var(--bg-app);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
    min-height: 100dvh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    overflow-x: hidden;
}

/* ============================================
   UTILITIES
   ============================================ */
.sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }

/* ============================================
   BUTTONS
   ============================================ */
.btn {
    font-family: var(--font-body);
    font-size: 0.9rem;
    font-weight: 600;
    padding: 12px 24px;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s var(--ease-out);
    border: none;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    line-height: 1;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
}
.btn:active { transform: scale(0.97); }
.btn-primary {
    background: var(--accent);
    color: var(--text-inverse);
    box-shadow: var(--shadow-sm), inset 0 1px 0 rgba(255,255,255,0.1);
}
.btn-primary:hover { background: var(--accent-hover); box-shadow: var(--shadow-md); }
.btn-secondary {
    background: var(--bg-surface);
    color: var(--text-primary);
    border: 1px solid var(--border);
    box-shadow: var(--shadow-xs);
}
.btn-secondary:hover { background: var(--bg-surface-hover); border-color: var(--text-muted); }
.btn-ghost {
    background: transparent;
    color: var(--text-secondary);
    padding: 8px 12px;
}
.btn-ghost:hover { background: var(--bg-surface-sunken); color: var(--text-primary); }
.btn-danger { background: var(--danger); color: white; }
.btn-danger:hover { opacity: 0.9; }
.btn-sm { padding: 8px 16px; font-size: 0.82rem; }
.btn-lg { padding: 16px 32px; font-size: 1rem; }
.btn-icon {
    width: 40px; height: 40px; padding: 0;
    border-radius: var(--radius-md);
    display: flex; align-items: center; justify-content: center;
}
.btn-icon svg { width: 20px; height: 20px; }

/* ============================================
   FORM ELEMENTS
   ============================================ */
textarea, input[type="text"] {
    width: 100%;
    padding: 14px 16px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-md);
    font-family: var(--font-body);
    font-size: 1rem;
    line-height: 1.6;
    background: var(--bg-surface);
    color: var(--text-primary);
    transition: border-color 0.2s, box-shadow 0.2s;
    resize: vertical;
    -webkit-appearance: none;
}
textarea:focus, input[type="text"]:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: var(--shadow-focus);
}
textarea::placeholder, input::placeholder { color: var(--text-muted); }
textarea.large { min-height: 140px; }
textarea.scene-textarea { min-height: 280px; font-family: 'Courier New', Courier, monospace; font-size: 0.95rem; }
.input-group { margin-bottom: 24px; }
.input-label { display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-primary); font-size: 0.92rem; }
.input-hint { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px; line-height: 1.5; }

/* ============================================
   ONBOARDING
   ============================================ */
.onboarding {
    min-height: 100vh;
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 24px;
    text-align: center;
    animation: onboardFadeIn 0.8s var(--ease-out);
}
@keyframes onboardFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
.onboarding-logo {
    font-family: var(--font-display);
    font-size: 2.8rem;
    font-weight: 300;
    color: var(--text-primary);
    margin-bottom: 8px;
    letter-spacing: -0.03em;
    line-height: 1.1;
}
.onboarding-logo em {
    font-style: italic;
    color: var(--accent);
}
.onboarding-byline {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin-bottom: 48px;
    letter-spacing: 0.03em;
}
.onboarding-pitch {
    max-width: 520px;
    margin-bottom: 48px;
}
.onboarding-pitch h2 {
    font-family: var(--font-display);
    font-size: 1.6rem;
    font-weight: 400;
    color: var(--text-primary);
    margin-bottom: 16px;
    line-height: 1.3;
}
.onboarding-pitch p {
    color: var(--text-secondary);
    font-size: 1.02rem;
    line-height: 1.7;
    margin-bottom: 12px;
}
.onboarding-steps {
    display: flex;
    gap: 32px;
    margin-bottom: 48px;
    flex-wrap: wrap;
    justify-content: center;
}
.onboarding-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    max-width: 140px;
}
.onboarding-step-num {
    width: 36px; height: 36px;
    background: var(--accent);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.85rem;
}
.onboarding-step-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
    text-align: center;
    line-height: 1.4;
}
.onboarding-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
    align-items: center;
}
.onboarding-actions .btn { min-width: 240px; }
.onboarding-footer {
    margin-top: 48px;
    font-size: 0.8rem;
    color: var(--text-muted);
}
.onboarding-footer a {
    color: var(--accent-text);
    text-decoration: none;
}

/* ============================================
   DASHBOARD
   ============================================ */
.dashboard {
    max-width: 720px;
    margin: 0 auto;
    padding: 32px 20px 100px;
}
.dashboard-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
    gap: 16px;
}
.dashboard-brand {
    font-family: var(--font-display);
    font-size: 1.4rem;
    font-weight: 400;
    letter-spacing: -0.02em;
}
.dashboard-brand em { font-style: italic; color: var(--accent); }
.dashboard-toolbar {
    display: flex;
    gap: 8px;
}
.scripts-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.script-card {
    background: var(--bg-surface);
    border-radius: var(--radius-lg);
    padding: 20px;
    border: 1.5px solid var(--border);
    cursor: pointer;
    transition: all 0.2s var(--ease-out);
    -webkit-tap-highlight-color: transparent;
}
.script-card:hover { border-color: var(--accent); box-shadow: var(--shadow-md); }
.script-card:active { transform: scale(0.99); }
.script-card-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 12px;
}
.script-card-title {
    font-family: var(--font-display);
    font-size: 1.3rem;
    font-weight: 500;
    color: var(--text-primary);
    line-height: 1.2;
}
.script-card-menu {
    flex-shrink: 0;
    width: 32px; height: 32px;
    display: flex; align-items: center; justify-content: center;
    border-radius: var(--radius-sm);
    cursor: pointer;
    color: var(--text-muted);
    transition: all 0.15s;
    border: none; background: none;
}
.script-card-menu:hover { background: var(--bg-surface-sunken); color: var(--text-primary); }
.script-card-meta {
    font-size: 0.82rem;
    color: var(--text-muted);
    margin-bottom: 14px;
}
.script-card-progress-track {
    height: 4px;
    background: var(--bg-surface-sunken);
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 8px;
}
.script-card-progress-bar {
    height: 100%;
    background: var(--accent);
    border-radius: 2px;
    transition: width 0.5s var(--ease-out);
}
.script-card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.script-card-phase {
    font-size: 0.78rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    font-weight: 600;
}
.script-card-percent {
    font-size: 0.82rem;
    color: var(--accent-text);
    font-weight: 600;
}
.empty-state {
    text-align: center;
    padding: 80px 24px;
}
.empty-state-icon {
    font-size: 2.5rem;
    margin-bottom: 16px;
    opacity: 0.4;
}
.empty-state h3 {
    font-family: var(--font-display);
    font-size: 1.5rem;
    font-weight: 400;
    color: var(--text-primary);
    margin-bottom: 8px;
}
.empty-state p { color: var(--text-secondary); }

.new-script-btn {
    width: 100%;
    padding: 18px;
    border: 2px dashed var(--border);
    border-radius: var(--radius-lg);
    background: transparent;
    color: var(--text-muted);
    font-family: var(--font-body);
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s var(--ease-out);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    -webkit-tap-highlight-color: transparent;
}
.new-script-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: var(--accent-glow);
}

/* ============================================
   WORKBOOK SHELL
   ============================================ */
.workbook { display: none; min-height: 100vh; min-height: 100dvh; }
.workbook.active { display: flex; flex-direction: column; }

/* Top nav bar */
.workbook-topbar {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--bg-surface);
    border-bottom: 1px solid var(--border);
    height: var(--nav-height);
    display: flex;
    align-items: center;
    padding: 0 16px;
    gap: 12px;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
}
.topbar-back {
    width: 36px; height: 36px;
    display: flex; align-items: center; justify-content: center;
    border-radius: var(--radius-sm);
    border: none; background: none;
    cursor: pointer;
    color: var(--text-primary);
    font-size: 1.2rem;
    -webkit-tap-highlight-color: transparent;
    transition: background 0.15s;
    flex-shrink: 0;
}
.topbar-back:hover { background: var(--bg-surface-sunken); }
.topbar-center {
    flex: 1;
    min-width: 0;
    text-align: center;
}
.topbar-title {
    font-family: var(--font-display);
    font-size: 1.05rem;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.topbar-save {
    font-size: 0.72rem;
    color: var(--text-muted);
    margin-top: 1px;
}
.topbar-save.saving { color: var(--accent); }
.topbar-save.saved { color: var(--success); }
.topbar-actions {
    display: flex;
    gap: 4px;
    flex-shrink: 0;
}

/* Workbook body */
.workbook-body {
    flex: 1;
    display: flex;
    overflow: hidden;
}

/* Desktop sidebar */
.workbook-sidebar {
    width: 260px;
    background: var(--bg-surface);
    border-right: 1px solid var(--border);
    overflow-y: auto;
    padding: 20px 0;
    flex-shrink: 0;
    display: none;
}
@media (min-width: 900px) {
    .workbook-sidebar { display: block; }
}
.sidebar-progress-block {
    padding: 0 20px;
    margin-bottom: 24px;
}
.sidebar-progress-label {
    display: flex;
    justify-content: space-between;
    font-size: 0.82rem;
    color: var(--text-secondary);
    margin-bottom: 8px;
}
.sidebar-progress-track {
    height: 6px;
    background: var(--bg-surface-sunken);
    border-radius: 3px;
    overflow: hidden;
}
.sidebar-progress-fill {
    height: 100%;
    background: var(--accent);
    border-radius: 3px;
    transition: width 0.5s var(--ease-out);
}
.sidebar-phase {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    padding: 20px 20px 8px;
    font-weight: 700;
}
.sidebar-nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 20px;
    font-size: 0.88rem;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.15s;
    border-left: 3px solid transparent;
    -webkit-tap-highlight-color: transparent;
    border-right: none; border-top: none; border-bottom: none;
    background: none;
    width: 100%;
    text-align: left;
    font-family: var(--font-body);
}
.sidebar-nav-item:hover { background: var(--bg-surface-hover); color: var(--text-primary); }
.sidebar-nav-item.active {
    background: var(--bg-accent-subtle);
    color: var(--accent-text);
    border-left-color: var(--accent);
    font-weight: 600;
}
.sidebar-nav-item.completed .nav-check {
    color: var(--success);
}
.nav-check {
    width: 18px; height: 18px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 50%;
    border: 1.5px solid var(--border);
    font-size: 0.65rem;
    flex-shrink: 0;
    transition: all 0.2s;
}
.sidebar-nav-item.completed .nav-check {
    border-color: var(--success);
    background: var(--success-bg);
}
.sidebar-nav-item.active .nav-check {
    border-color: var(--accent);
}

/* Mobile bottom nav */
.mobile-nav {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background: var(--bg-surface);
    border-top: 1px solid var(--border);
    padding: 8px 8px calc(8px + var(--safe-area-bottom));
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
}
@media (max-width: 899px) {
    .mobile-nav { display: block; }
    :root { --bottom-nav-height: calc(72px + var(--safe-area-bottom)); }
}
.mobile-nav-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 4px;
}
.mobile-nav-progress {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--bg-surface-sunken);
}
.mobile-nav-progress-fill {
    height: 100%;
    background: var(--accent);
    transition: width 0.5s var(--ease-out);
}
.mobile-nav-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    padding: 6px 4px;
    border: none;
    background: none;
    color: var(--text-muted);
    font-family: var(--font-body);
    font-size: 0.62rem;
    font-weight: 600;
    letter-spacing: 0.02em;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    transition: color 0.15s;
    border-radius: var(--radius-sm);
}
.mobile-nav-btn:active { background: var(--bg-surface-sunken); }
.mobile-nav-btn.active { color: var(--accent); }
.mobile-nav-btn svg { width: 22px; height: 22px; }
.mobile-nav-btn .nav-dot {
    width: 5px; height: 5px;
    border-radius: 50%;
    background: var(--success);
    display: none;
}
.mobile-nav-btn.completed .nav-dot { display: block; }

/* Main content area */
.workbook-main {
    flex: 1;
    overflow-y: auto;
    padding: 32px 24px calc(32px + var(--bottom-nav-height));
    scroll-behavior: smooth;
}
@media (min-width: 900px) {
    .workbook-main { padding: 40px 48px; }
}
.workbook-main-inner {
    max-width: 700px;
    margin: 0 auto;
}

/* Section animations */
.section-enter {
    animation: sectionIn 0.35s var(--ease-out);
}
@keyframes sectionIn {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ============================================
   CONTENT STYLES
   ============================================ */
.section-header {
    margin-bottom: 36px;
}
.section-phase {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--accent-text);
    margin-bottom: 8px;
    font-weight: 700;
}
.section-title {
    font-family: var(--font-display);
    font-size: 2rem;
    font-weight: 400;
    color: var(--text-primary);
    margin-bottom: 8px;
    line-height: 1.15;
    letter-spacing: -0.02em;
}
.section-subtitle {
    color: var(--text-secondary);
    font-size: 1rem;
    line-height: 1.5;
}
.content-block {
    margin-bottom: 36px;
}
.content-block h3 {
    font-family: var(--font-display);
    font-size: 1.3rem;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 12px;
}
.content-block p {
    margin-bottom: 14px;
    color: var(--text-primary);
    line-height: 1.7;
}
.content-block ul {
    margin-left: 20px;
    margin-bottom: 16px;
}
.content-block li {
    margin-bottom: 6px;
    color: var(--text-primary);
    line-height: 1.6;
}
.formula-box {
    background: var(--accent);
    color: white;
    padding: 24px;
    border-radius: var(--radius-lg);
    font-family: var(--font-display);
    font-size: 1.08rem;
    font-style: italic;
    line-height: 1.7;
    margin: 24px 0;
}
.formula-box strong { color: #fef08a; font-style: normal; }
.example-box {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-left: 3px solid var(--accent);
    padding: 18px 20px;
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
    margin: 14px 0;
}
.example-box-title { font-weight: 600; color: var(--text-primary); margin-bottom: 6px; font-size: 0.92rem; }
.example-box p { margin-bottom: 6px; font-size: 0.92rem; }
.example-box p:last-child { margin-bottom: 0; }
.tip-box {
    background: var(--bg-accent-subtle);
    border: 1px solid var(--accent-glow);
    border-radius: var(--radius-md);
    padding: 18px 20px;
    margin: 24px 0;
}
.tip-box-title { font-weight: 700; color: var(--accent-text); margin-bottom: 6px; font-size: 0.9rem; }
.tip-box p { font-size: 0.92rem; color: var(--text-secondary); margin: 0; }

.story-circle-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    margin: 20px 0;
}
@media (max-width: 600px) { .story-circle-grid { grid-template-columns: 1fr; } }
.story-point {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 18px;
}
.story-point-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}
.story-point-number {
    width: 28px; height: 28px;
    background: var(--accent);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.8rem;
    flex-shrink: 0;
}
.story-point-title { font-weight: 600; font-size: 0.88rem; color: var(--text-primary); }
.story-point textarea { min-height: 90px; }

/* 40 Points */
.forty-point-group {
    margin-bottom: 24px;
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    overflow: hidden;
}
.forty-point-group-header {
    background: var(--accent);
    color: white;
    padding: 14px 18px;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
}
.forty-point-group-number {
    width: 26px; height: 26px;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.8rem;
    flex-shrink: 0;
}
.forty-point-group-title { font-weight: 500; font-size: 0.95rem; }
.forty-point-scenes { padding: 18px; }
.forty-point-scene { margin-bottom: 18px; }
.forty-point-scene:last-child { margin-bottom: 0; }
.forty-point-scene-label {
    font-size: 0.82rem;
    color: var(--text-secondary);
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
}
.connector-hint {
    font-size: 0.72rem;
    font-weight: 500;
    background: var(--bg-surface-sunken);
    padding: 2px 8px;
    border-radius: 4px;
    color: var(--text-muted);
}

/* Scene guides */
.scene-guide {
    background: var(--bg-surface-sunken);
    border-left: 3px solid var(--accent);
    padding: 16px 18px;
    margin-bottom: 12px;
    font-size: 0.92rem;
    line-height: 1.65;
    color: var(--text-primary);
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
}
.scene-guide p { margin-bottom: 10px; }
.scene-guide p:last-child { margin-bottom: 0; }
.scene-guide .guide-intro { font-style: italic; color: var(--text-secondary); }
.scene-guide .guide-question {
    background: var(--bg-surface);
    padding: 10px 14px;
    border-radius: var(--radius-sm);
    margin-top: 10px;
}
.scene-guide .guide-examples { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
.scene-guide .guide-examples ul { margin-left: 0; padding-left: 18px; margin-top: 6px; }
.scene-guide .guide-examples li { margin-bottom: 8px; line-height: 1.55; font-size: 0.88rem; }
.scene-guide .guide-examples li strong { color: var(--accent-text); }

/* Scene writing */
.scene-writing-card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    margin-bottom: 20px;
}
.scene-writing-header {
    background: var(--bg-surface-sunken);
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
}
.scene-writing-header h4 {
    font-family: var(--font-display);
    font-size: 1.05rem;
    color: var(--text-primary);
    margin-bottom: 2px;
}
.scene-writing-header p { font-size: 0.85rem; color: var(--text-secondary); margin: 0; }
.scene-writing-body { padding: 18px; }
.scene-reference-box {
    background: var(--bg-accent-subtle);
    border: 1px solid var(--accent-glow);
    border-radius: var(--radius-md);
    padding: 14px;
    margin-bottom: 14px;
}
.scene-reference-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--accent-text);
    font-weight: 700;
    margin-bottom: 6px;
}
.scene-reference-content { color: var(--text-primary); font-size: 0.92rem; line-height: 1.5; }
.encouragement-box {
    background: var(--bg-surface-sunken);
    border-left: 3px solid var(--accent);
    padding: 10px 14px;
    margin-bottom: 14px;
    font-style: italic;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

/* Section navigation */
.section-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 48px;
    padding-top: 28px;
    border-top: 1px solid var(--border);
    gap: 12px;
}

/* ============================================
   MODALS
   ============================================ */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s var(--ease-out);
    padding: 20px;
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
}
.modal-overlay.active { opacity: 1; visibility: visible; }
.modal {
    background: var(--bg-surface);
    border-radius: var(--radius-xl);
    max-width: 440px;
    width: 100%;
    padding: 28px;
    box-shadow: var(--shadow-lg);
    transform: translateY(16px) scale(0.97);
    transition: transform 0.25s var(--ease-spring);
}
.modal-overlay.active .modal { transform: translateY(0) scale(1); }
.modal h2 {
    font-family: var(--font-display);
    font-size: 1.4rem;
    font-weight: 500;
    margin-bottom: 12px;
    color: var(--text-primary);
}
.modal p { color: var(--text-secondary); font-size: 0.95rem; line-height: 1.5; }
.modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 24px;
}

/* ============================================
   CELEBRATION
   ============================================ */
.celebration {
    text-align: center;
    padding: 40px 0;
}
.celebration-icon { font-size: 3.5rem; margin-bottom: 20px; }
.celebration h2 {
    font-family: var(--font-display);
    font-size: 2rem;
    font-weight: 400;
    margin-bottom: 14px;
    color: var(--text-primary);
}
.celebration p {
    color: var(--text-secondary);
    max-width: 480px;
    margin: 0 auto 28px;
    line-height: 1.7;
}

/* ============================================
   PRINT
   ============================================ */
@media print {
    .workbook-topbar, .workbook-sidebar, .mobile-nav, .section-nav, .btn { display: none !important; }
    .workbook-body { display: block !important; }
    .workbook-main { padding: 0 !important; overflow: visible !important; }
    body { background: white; }
}

/* ============================================
   SCENE PAGINATION
   ============================================ */
.scene-paginator {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin: 24px 0;
    flex-wrap: wrap;
}
.scene-page-btn {
    width: 36px; height: 36px;
    display: flex; align-items: center; justify-content: center;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--bg-surface);
    color: var(--text-secondary);
    font-size: 0.82rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    font-family: var(--font-body);
    -webkit-tap-highlight-color: transparent;
}
.scene-page-btn:hover { border-color: var(--accent); color: var(--accent); }
.scene-page-btn.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
}
.scene-page-btn.has-content {
    border-color: var(--success);
    color: var(--success);
}
.scene-page-btn.has-content.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
}

/* ============================================
   TOAST NOTIFICATIONS
   ============================================ */
.toast-container {
    position: fixed;
    bottom: calc(20px + var(--bottom-nav-height));
    left: 50%;
    transform: translateX(-50%);
    z-index: 500;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    pointer-events: none;
}
.toast {
    background: var(--text-primary);
    color: var(--bg-app);
    padding: 12px 20px;
    border-radius: var(--radius-lg);
    font-size: 0.88rem;
    font-weight: 500;
    box-shadow: var(--shadow-lg);
    pointer-events: auto;
    display: flex;
    align-items: center;
    gap: 10px;
    max-width: 360px;
    animation: toastIn 0.3s var(--ease-spring), toastOut 0.3s var(--ease-out) 4.7s forwards;
}
.toast-action {
    color: var(--accent);
    font-weight: 700;
    cursor: pointer;
    white-space: nowrap;
    background: none;
    border: none;
    font-family: var(--font-body);
    font-size: 0.88rem;
    padding: 0;
}
@keyframes toastIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
@keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-8px); } }

/* ============================================
   COLLAPSIBLE 40-POINT GROUPS
   ============================================ */
.forty-point-group-header {
    user-select: none;
    position: relative;
}
.forty-point-group-header::after {
    content: '';
    width: 8px; height: 8px;
    border-right: 2px solid rgba(255,255,255,0.6);
    border-bottom: 2px solid rgba(255,255,255,0.6);
    transform: rotate(45deg);
    transition: transform 0.2s var(--ease-out);
    margin-left: auto;
    flex-shrink: 0;
}
.forty-point-group.collapsed .forty-point-group-header::after {
    transform: rotate(-45deg);
}
.forty-point-scenes {
    transition: none;
}
.forty-point-group.collapsed .forty-point-scenes {
    display: none;
}

/* ============================================
   BACKUP INFO IN SETTINGS
   ============================================ */
.backup-info {
    background: var(--bg-surface-sunken);
    border-radius: var(--radius-md);
    padding: 14px 16px;
    margin-bottom: 16px;
    font-size: 0.85rem;
    color: var(--text-secondary);
    line-height: 1.5;
}
.backup-info strong { color: var(--text-primary); }
.backup-warning {
    color: var(--danger);
    font-weight: 500;
}

/* ============================================
   SECTION EXPORT BAR
   ============================================ */
.section-export {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 14px 18px;
    margin-top: 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
}
.section-export-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
}
.section-export .btn svg {
    width: 16px;
    height: 16px;
}
    </style>
</head>
<body>

<!-- ============================================
     SCREEN: ONBOARDING
     ============================================ -->
<div class="onboarding" id="screenOnboarding">
    <div class="onboarding-logo">Story from Start<br><em>to Finish</em></div>
    <p class="onboarding-byline">by Blake Armstrong · Robot Eating Robot</p>

    <div class="onboarding-pitch">
        <h2>Finish your screenplay in 45 days.</h2>
        <p>A guided system that breaks the overwhelming task of writing a screenplay into daily assignments you can knock out on a lunch break. No staring at blank pages. No getting lost in Act 2. Just structured progress, one scene at a time.</p>
    </div>

    <div class="onboarding-steps">
        <div class="onboarding-step">
            <div class="onboarding-step-num">1</div>
            <div class="onboarding-step-label">Craft your logline &amp; story circle</div>
        </div>
        <div class="onboarding-step">
            <div class="onboarding-step-num">2</div>
            <div class="onboarding-step-label">Build a 40-point scene structure</div>
        </div>
        <div class="onboarding-step">
            <div class="onboarding-step-num">3</div>
            <div class="onboarding-step-label">Write one scene per day for 40 days</div>
        </div>
    </div>

    <div class="onboarding-actions">
        <button class="btn btn-primary btn-lg" onclick="App.dismissOnboarding(); App.createNewScript();">Start Your First Script</button>
        <button class="btn btn-ghost" onclick="App.importData(); App.dismissOnboarding();">Import Existing Work</button>
    </div>

    <div class="onboarding-footer">
        All your work stays on this device · <a href="#">Learn more</a>
    </div>
</div>

<!-- ============================================
     SCREEN: DASHBOARD
     ============================================ -->
<div class="dashboard" id="screenDashboard" style="display:none;">
    <div class="dashboard-header">
        <div class="dashboard-brand">Start <em>to</em> Finish</div>
        <div class="dashboard-toolbar">
            <button class="btn btn-ghost btn-sm" onclick="App.importData()" title="Import backup">Import</button>
            <button class="btn btn-ghost btn-sm" onclick="App.exportAllData()" title="Export backup">Export</button>
        </div>
    </div>
    <div id="scriptsContainer"></div>
    <button class="new-script-btn" onclick="App.createNewScript()">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
        New Script
    </button>
</div>

<!-- ============================================
     SCREEN: WORKBOOK
     ============================================ -->
<div class="workbook" id="screenWorkbook">
    <!-- Top bar -->
    <header class="workbook-topbar">
        <button class="topbar-back" onclick="App.goToDashboard()" aria-label="Back to scripts">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <div class="topbar-center">
            <div class="topbar-title" id="topbarTitle">Untitled Script</div>
            <div class="topbar-save" id="topbarSave">All changes saved</div>
        </div>
        <div class="topbar-actions">
            <button class="btn-icon btn-ghost" onclick="App.showSettings()" aria-label="Settings">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            </button>
        </div>
    </header>

    <div class="workbook-body">
        <!-- Desktop sidebar -->
        <aside class="workbook-sidebar" id="workbookSidebar"></aside>

        <!-- Main content -->
        <main class="workbook-main" id="workbookMain">
            <div class="workbook-main-inner" id="mainContent"></div>
        </main>
    </div>

    <!-- Mobile bottom nav -->
    <nav class="mobile-nav" id="mobileNav">
        <div class="mobile-nav-progress">
            <div class="mobile-nav-progress-fill" id="mobileProgressFill" style="width:0%"></div>
        </div>
        <div class="mobile-nav-inner" id="mobileNavInner"></div>
    </nav>
</div>

<!-- ============================================
     MODALS
     ============================================ -->
<div class="modal-overlay" id="newScriptModal">
    <div class="modal">
        <h2>Start a New Script</h2>
        <div class="input-group">
            <label class="input-label">Working Title</label>
            <input type="text" id="newScriptTitle" placeholder="My Screenplay">
        </div>
        <div class="modal-actions">
            <button class="btn btn-ghost" onclick="App.closeModal('newScriptModal')">Cancel</button>
            <button class="btn btn-primary" onclick="App.confirmNewScript()">Create</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="deleteModal">
    <div class="modal">
        <h2>Delete Script?</h2>
        <p>This permanently deletes "<span id="deleteScriptName"></span>" and all its content.</p>
        <div class="modal-actions">
            <button class="btn btn-ghost" onclick="App.closeModal('deleteModal')">Cancel</button>
            <button class="btn btn-danger" onclick="App.confirmDelete()">Delete</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="settingsModal">
    <div class="modal">
        <h2>Script Settings</h2>
        <div class="input-group">
            <label class="input-label">Title</label>
            <input type="text" id="settingsTitle">
        </div>
        <div class="backup-info" id="backupInfo">
            <strong>Backup Status:</strong> Your work is saved locally on this device. Export regularly to avoid data loss.
        </div>
        <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
            <button class="btn btn-secondary btn-sm" onclick="App.exportCurrentScript()">Export This Script</button>
            <button class="btn btn-secondary btn-sm" onclick="App.exportAllData()">Export All Scripts</button>
            <button class="btn btn-secondary btn-sm" onclick="window.print()">Print / PDF</button>
        </div>
        <div class="modal-actions">
            <button class="btn btn-ghost" onclick="App.closeModal('settingsModal')">Cancel</button>
            <button class="btn btn-primary" onclick="App.saveSettings()">Save</button>
        </div>
    </div>
</div>

<input type="file" id="importInput" accept=".json" style="display:none">
<div class="toast-container" id="toastContainer"></div>

<script>
/* ============================================
   DATA / CONTENT LAYER
   Separated from UI so it's maintainable
   ============================================ */

const CONTENT = {
    nav: [
        { id: 'logline', label: 'Logline', phase: 'Foundation', phaseNum: 1, day: '1', icon: 'edit' },
        { id: 'storycircle', label: 'Story Circle', phase: 'Foundation', phaseNum: 1, day: '2', icon: 'circle' },
        { id: 'variations', label: 'Variations', phase: 'Foundation', phaseNum: 1, day: '3', icon: 'shuffle' },
        { id: 'fortypoints', label: '40 Points', phase: 'Structure', phaseNum: 2, day: '4', icon: 'list' },
        { id: 'fortyrevise', label: 'Revise 40', phase: 'Structure', phaseNum: 2, day: '5', icon: 'pen' },
        { id: 'scenes', label: 'Scenes', phase: 'Writing', phaseNum: 3, day: '6–45', icon: 'film' },
        { id: 'celebrate', label: 'Celebrate', phase: 'Completion', phaseNum: 4, day: '46', icon: 'star' },
    ],

    mobileNavIcons: {
        edit: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
        circle: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>',
        shuffle: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg>',
        list: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>',
        pen: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>',
        film: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/><line x1="17" y1="17" x2="22" y2="17"/></svg>',
        star: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
    },

    storyCirclePoints: [
        { num: 1, title: 'CHARACTER', hint: 'Who are they? Good, bad? Brave or coward? Make them opposite to your theme/ending for good conflict.' },
        { num: 2, title: 'WANT', hint: 'What do they want internally (love, revenge, achievement) AND externally (escape dinosaurs, get promotion)?' },
        { num: 3, title: 'GO', hint: 'They enter an unfamiliar situation. Bars full of aliens, islands of dinosaurs. The new world kicks their butt.' },
        { num: 4, title: 'ADAPT', hint: 'They start to change. Old methods fail. Only when they lean into change can they move toward their want.' },
        { num: 5, title: 'GET', hint: "They get what they THINK they wanted! Close enough to kill the king. Won the contest. At their goal!" },
        { num: 6, title: 'PAY', hint: "BUT! They're found out. Must tell the truth. Left friends behind. Down in the dumps—and they did it to themselves." },
        { num: 7, title: 'RETURN', hint: "With everything learned, they get back on that horse. Use new knowledge. Charge in ready to fight." },
        { num: 8, title: 'CHANGED', hint: "This isn't page 1's protagonist. They defeat the bad guy. What new normal can they usher forth?" },
    ],

    storyPointNames: ['CHARACTER', 'WANT', 'GO', 'ADAPT', 'GET', 'PAY', 'RETURN', 'CHANGED'],

    encouragements: [
        "The first scene is always the hardest. Just start—you can fix it later.",
        "You're building momentum. Keep going.",
        "Three scenes in. You're doing this.",
        "Trust the outline. Let the words flow.",
        "One-eighth of your script is taking shape. Feel that?",
        "New story point, new energy. Dive in.",
        "You know this character now. Show us who they are.",
        "The world is expanding. Let it breathe.",
        "Conflict makes story. Lean into the tension.",
        "Quarter of the way there. You're ahead of most people who say they want to write.",
        "Today's scene matters. Tomorrow's scene will too. One at a time.",
        "Your characters are starting to surprise you. That's good.",
        "The middle is where most writers quit. You won't.",
        "Every scene is a promise kept to yourself.",
        "Adaptation is where your character earns their change.",
        "What would your protagonist never do? Maybe they do it today.",
        "You're not writing a perfect draft. You're writing a first draft.",
        "The only bad scene is the one you didn't write.",
        "Almost halfway. The back half goes faster.",
        "Halfway. Stop and appreciate what you've built.",
        "The peak approaches. Your character thinks they've won.",
        "What does victory taste like? Write it.",
        "Let them have their moment. It won't last.",
        "Success comes with a cost. What's theirs?",
        "Five-eighths done. The fall is coming.",
        "Time to pay the price. Make it hurt.",
        "Consequences are where character is revealed.",
        "Your protagonist earned this low point. Now they'll earn their way out.",
        "Rock bottom is just a foundation to build on.",
        "Three-quarters done. You can see the end from here.",
        "The return begins. What did they learn?",
        "Old self meets new self. Who wins?",
        "Everything they've learned gets tested now.",
        "The final push. Leave nothing in the tank.",
        "Seven-eighths complete. You're in the home stretch.",
        "Resolution is earned, not given. Earn it.",
        "The world has changed. Show us how.",
        "Your character has changed. Prove it.",
        "Second to last scene. Make it count.",
        "Final scene. You did it. Write THE END.",
    ],

    loglineExamples: [
        { title: 'Gladiator', text: "A former Roman General is nearly assassinated by the new, brutal and jealous Emperor. He sets out to exact vengeance against the corrupt emperor who murdered his family before Rome falls to the emperor's corruption.", detail: "<strong>Character:</strong> Former Roman General · <strong>Disruption:</strong> Nearly assassinated · <strong>Objective:</strong> Kill the emperor · <strong>Stakes:</strong> Rome falls to corruption" },
        { title: 'Die Hard', text: "A New York City police officer tries to save his estranged wife and several others taken hostage by terrorists during a Christmas party at the Nakatomi Plaza in Los Angeles." },
        { title: 'Aladdin', text: "A common thief finds a genie who will grant him three wishes and must choose his wishes wisely to win the heart of the princess and pull himself out of a life of petty crime." },
        { title: 'Silence of the Lambs', text: "A young F.B.I. cadet must take the help of an incarcerated and manipulative cannibal killer to help catch another serial killer: a madman who skins his victims, before another girl is killed." },
        { title: 'Alien', text: "The crew of the commercial space tug Nostromo, after coming across a mysterious derelict spaceship on an uncharted planetoid, find themselves up against an aggressive and deadly extraterrestrial set loose on their ship." },
    ],
};

// The 40-point box guides — extracted from original code
// This is the big content payload. Keeping it as a separate object for clarity.
// (I'm including it inline since it needs to ship as one file)
const BOX_GUIDES = {
1:[
{intro:"This is your opening page, Point 1 of your 40 points. Think of this as Act One of the character situation mapped to its own mini story circle.",question:"What is the biggest action that shows who your character is? What is their biggest flaw—the thing they <em>think</em> they want?",examples:[["Finding Nemo","Marlin is neurotic and over-protective of his son to the point of stifling his growth"],["The Lion King","Simba has unearned confidence"],["Star Wars","Luke Skywalker is a punk kid who's never left home and is naive to the ways of the world"],["Gladiator","Maximus Decimus Meridius fights for the good emperor of Rome and expects his good government will reward him"],["Aladdin","Aladdin is a smart street thief who wishes for a life of wealth and ease"]]},
{intro:"In Act Two of your character section, where does your character go in their normal, everyday lives? What situations have they already adapted to?",examples:[["Finding Nemo","Marlin keeps Nemo on a tight leash and hasn't even let him go to school yet"],["The Lion King","Simba abuses what little power he has and takes no responsibility"],["Star Wars","Luke deals with farm life and busted droids"],["Gladiator","Maximus prepares to fight the barbarians of Germania and takes council with Emperor Marcus Aurelius"],["Aladdin","Aladdin steals food and avoids the city guards"]]},
{intro:"In Act Three of your character section, is there anything they get? Even something simple—recognition from their boss they thought they wanted? Getting called in for a meeting?",examples:[["Finding Nemo","Marlin is bombarding Nemo with rules"],["The Lion King","Simba is shown everything the light touches will be his in the future"],["Star Wars","Luke is given his responsibility on the moisture farm"],["Gladiator","Maximus wins the battle"],["Aladdin","Aladdin gets his bread and avoids the guards!"]]},
{intro:"This is Act Four of your character section where they might have to pay for what they got. This is also a spot to start laying in complications.",examples:[["Finding Nemo","Marlin loses all his social standing with how overbearing he is with Nemo"],["The Lion King","Simba is also told that being king is a lot of responsibility"],["Star Wars","Luke has to stay on the farm for yet another season"],["Gladiator","Maximus is informed by the emperor that things may not always be this way. He also has to recognize the injured and dead soldiers from his army"],["Aladdin","Aladdin gives his bread to the hungry kids, is whipped by a grumpy prince, and humiliated in the streets"]]},
{intro:"Here they have NOT changed. Their flaw can really shine. Maybe your protagonist is too much of a coward to stand up to their jerk boss.",examples:[["Finding Nemo","Marlin hesitates to let Nemo go to school"],["The Lion King","Simba bosses around Zazu"],["Star Wars","Luke complains but continues farm work by cleaning up the droids"],["Gladiator","Maximus is obedient to the emperor"],["Aladdin","Aladdin heads back home completely empty handed"]]}
],
2:[
{intro:"How is your character feeling now? What side of them are we seeing? This is also a great place to set up your inciting incident.",details:"Maybe they've got one more chance to prove themselves at work and they're ready to do their best—which still isn't good enough because of their flaw. Too uptight? Too loose? Too clingy? Too nervous? We see that they want to cling to their old ways.",examples:[["Finding Nemo","Marlin's overprotection intensifies as he relented to allowing Nemo to go to school"],["The Lion King","Simba's confidence builds"],["Star Wars","Luke yearns for adventure that's more than blasting womp-rats with his buddies"],["Gladiator","Maximus yearns for home"],["Aladdin","Aladdin is home and hungry, looking at the palace, showing Jasmine a beautiful view"]]},
{intro:"This is the perfect spot for your inciting incident—a call to adventure that they do NOT want to take!",details:"They get a chance at a new company. They are called to foreign lands. There's a new case on their desk even though they're supposed to retire. How do they react? They have to adapt to being called to become a better, more well-rounded person. And they should adapt by finding any way to get out of that obligation.<br><br>Even Aragorn is only taking the hobbits as far as Rivendell—he has not accepted that he must become king. He will do some of what is right, but avoid full commitment. Frodo will try and give Gandalf the ring after Bilbo's party.",examples:[["Finding Nemo","Marlin doesn't want anything to happen to Nemo at the drop off"],["The Lion King","Simba sings about how he just can't wait to be king!"],["Star Wars","Luke receives the message from Leia"],["Gladiator","Maximus expresses to emperor Marcus Aurelius his want to go home to his family when the campaign finishes"],["Aladdin","Aladdin talks about his want to be rich and live in the palace with servants and an easy life"]]},
{intro:"This is the part where they get what they want.",examples:[["Finding Nemo","Marlin finds Nemo and embarrasses him in front of everyone"],["The Lion King","Simba stands up against the hyenas and shows the seeds of his courage"],["Star Wars","Luke finds old Ben Kenobi to help him out"],["Gladiator","Maximus tells the new emperor Commodus that he will not lead the army. He wants out. He just wants to go home"],["Aladdin","Aladdin finds out the woman he saved is the princess"],["Lord of the Rings","Aragorn feels like he has done his duty by bringing the hobbits to Rivendell"]]},
{intro:"But now they have to pay.",details:"Rivendell isn't far enough. Maybe your guy who just got the opportunity for a second chance at his job has his big presentation, bombs, and gets fired.",examples:[["Finding Nemo","Nemo tells Marlin \"I hate you\" and is kidnapped"],["The Lion King","Scar just sang about his own wants and now Mufasa is dead. Simba would be stuck being king at the cost of his father's life"],["Star Wars","Luke got his family involved with things bigger than himself and his aunt and uncle are killed"],["Gladiator","Maximus is not only kicked out of the army—he's going to be executed!"],["Aladdin","Aladdin gets to go to the palace, but to the palace dungeon"]]},
{intro:"So what now? Your protagonist's situation has totally changed and they've really got to look at what they want.",details:"Crawl back to the old boss? Ignore the fact that the free world is in peril? They can't. They've seen too much. The good in them makes them take that step toward adventure, but that flaw is going to make them stumble along the way. They WANT to save the world, but they want to do it in such a way that they don't have to change.",examples:[["Finding Nemo","Marlin sees that it's his fault that Nemo was taken"],["The Lion King","Simba wants to bring no more harm to the pride lands so he goes to live in exile"],["Star Wars","Luke commits to following Obi-Wan"],["Gladiator","Maximus is an exile of Rome and his family is dead"],["Aladdin","Aladdin wants to escape the dungeon instead of only escaping poverty"]]}
],
3:[
{intro:"So who is your character now? This will probably be somewhere between pages 20-25 of your script.",details:"They're in somewhere or some situation that is so completely foreign to them. How are they reacting? Are they bold? Timid? How are they still clinging to that old flaw as they move through this new world? What do they want here? Do they want to get the hobbits to Mordor? Save the princess? Approach that wild idea they've always had?",examples:[["Finding Nemo","Marlin, completely distraught, meets carefree Dory"],["The Lion King","Simba, alone for the first time ever, has to wander the desert"],["Star Wars","Luke, the isolated farm boy, goes to the cantina in Mos Eisley"],["Gladiator","Maximus, emotionally dead, is captured by slave traders"],["Aladdin","Aladdin is given an opportunity to escape if he will brave the Cave of Wonders"]]},
{intro:"How does your character get there? In this Go section, they've got to GO!",details:"What does this change of scenery look like for your protagonist? How do they feel about the new people they are surrounded by?",examples:[["Finding Nemo","Marlin and Dory journey through the dark ocean"],["The Lion King","Simba finds an oasis in the desert"],["Star Wars","Luke goes with Han Solo into space!"],["Gladiator","Maximus is pressed into becoming a small time gladiator in the fringes of the empire—far from Rome, the military, his family—anything he knew before"],["Aladdin","Aladdin goes through the trials of the Cave of Wonders, full of treasures beyond his wildest dreams, and meets the Genie"],["Lord of the Rings","Frodo and the hobbits leave the Shire and hit the road"]]},
{intro:"Now they are too far to turn back.",examples:[["Finding Nemo","Marlin and Dory find themselves in a trench far away from home BUT they found a clue to where Nemo might be headed"],["The Lion King","Simba finds himself a new carefree lifestyle"],["Star Wars","Luke and Han have to fight off Imperial TIE fighters"],["Gladiator","Maximus is impressing his masters"],["Aladdin","Aladdin is turned into Prince Ali!"],["Lord of the Rings","Frodo and the hobbits are seen by Saruman's spies"]]},
{intro:"What do they have to pay for with this new part of their journey?",examples:[["Finding Nemo","Marlin has to take Dory, who he finds annoying, on this journey with him"],["The Lion King","Simba has to eat bugs"],["Star Wars","Luke and Han are captured by the Empire"],["Gladiator","Maximus is fighting in real gladiator battles and winning, but risking his life for the entertainment of the crowd"],["Aladdin","Aladdin has pumped himself up like a haughty prince and ends up infuriating Princess Jasmine"],["Lord of the Rings","This can get tricky. Frodo and the hobbits are one story, Aragorn himself is another, and the fellowship as a third is yet another. With the story of just the hobbits, they took the short cut and are now actively pursued by the ring wraiths. Aragorn, on his personal journey for just the fraction of the fellowship of the ring, has got to pay for going with the hobbits and that is fighting the ring wraiths at Weathertop and failing to protect Frodo. For the whole Fellowship story, Frodo and the Fellowship are stuck in the high mountains and beset by an evil blizzard"]]},
{intro:"Now they have to change course. This is probably happening somewhere between pages 30-40.",question:"What's your protagonist's new disposition?",examples:[["Finding Nemo","Marlin does his best to tolerate Dory"],["The Lion King","Simba finds the bugs slimy, yet satisfying"],["Star Wars","Luke and Han have to figure out how to get out of the Empire's clutches"],["Gladiator","Maximus is now winning these battles with ease"],["Aladdin","Aladdin now sees that his new Prince Ali persona is not what the princess wants"],["Lord of the Rings","The Fellowship has to change their route and head to Moria"]]}
],
4:[
{intro:"So what is your protagonist to do? They tried something and it didn't work. Who should they be now?",details:"Everyone is still going after their internal and external wants, but with a little more comfort—or at least familiarity—in this new world.",examples:[["Finding Nemo","Marlin learns from Dory's sunny disposition that sometimes a good attitude can get you farther"],["The Lion King","Simba is chilling with the boys! His new buddies have taught him how to stop worrying. They're singing and living a carefree life. He's grown into a soft, carefree adult"],["Star Wars","Luke and Han have taken on the disguise of stormtroopers to adapt to the dangerous environment of the Imperial Star Destroyer"],["Gladiator","Maximus is winning his battles too easily—\"Are you not entertained?!\""],["Aladdin","Aladdin is dejected because his plan didn't work. He still wants Princess Jasmine but is not willing to be himself. He's still clinging to the idea that a prince is all riches and legal power—not justice, prudence, and cunning"],["Lord of the Rings","The Fellowship has arrived at the gates of Moria but can't seem to get in"]]},
{intro:"Here the characters go and adapt yet again to this new environment they are now better equipped to handle.",examples:[["Finding Nemo","Marlin grows more flexible and tries to play a game with Dory"],["The Lion King","Simba settles into his new life and grows into an adult"],["Star Wars","Luke and Han infiltrate the Star Destroyer"],["Gladiator","Maximus is told that if he fights well and puts on a show, he could have a chance at going to Rome for the Coliseum—a chance to kill Emperor Commodus"],["Aladdin","Aladdin has to confront Jasmine and smooth things over. But he's still not ready to admit he's really a street thief. He tries to adapt his Prince Ali persona to his gentle Aladdin personality by offering Jasmine a magic carpet ride. He wants to care for her needs—her desire to escape the bounds of the palace"],["Lord of the Rings","The Fellowship defeats the Kraken, solves the riddle, and enters the Mines of Moria. But they must now adapt to the fact that they will not be welcomed by dwarf kings—they must sneak through what is now a tomb"]]},
{intro:"So what does everyone get? Your protagonist is probably growing some confidence by now.",examples:[["Finding Nemo","Marlin and Dory speed through a dangerous field of jellyfish—having fun on their adventure while they're at it"],["The Lion King","Simba gets to look at the stars and ponder big ideas with his friends without any worries"],["Star Wars","Luke gains confidence in his abilities to free the princess"],["Gladiator","Maximus absolutely slays every gladiator he fights"],["Aladdin","Aladdin gets on the good side of Jasmine"],["Lord of the Rings","The Fellowship gets closer to crossing through the mountains"]]},
{intro:"And what do they have to pay for with this adaptation?",examples:[["Finding Nemo","Marlin finds Dory is injured"],["The Lion King","Simba is feeling a pang of guilt that he has neglected his duty. He has to take a moment alone and feel the torment of remembering the words of his father"],["Star Wars","Luke and Han have now alerted the Empire that they're on board"],["Gladiator","Maximus is scolded that if he doesn't put on a show he will be sidelined"],["Aladdin","Aladdin is now deeper into his lie of being a prince"],["Lord of the Rings","The Fellowship have awakened the goblins and the trolls and something far worse which was released when the greedy dwarves dug too deep"]]},
{intro:"Now our protagonists know the situation has changed, but they've seen the curveballs this world can throw. They've adapted and are ready for what comes next.",question:"How does your character show this?"}
],
5:[
{intro:"What comes next is they get what they want! They're now a citizen of this new world and ready to tackle its challenges.",examples:[["Finding Nemo","Marlin's new allies, the turtles, escort him close to Sydney"],["The Lion King","Simba brushes off his guilt and his father's words and continues on his carefree way"],["Star Wars","Luke and Han have figured out where the princess is and how to navigate the empire's ship"],["Gladiator","Maximus is now fighting in the Coliseum and has sight of the emperor. Maximus is in Rome!"],["Aladdin","Aladdin's relationship with Jasmine deepens"],["Lord of the Rings","The Fellowship is prepared for battle. They've beaten Krakens and Ringwraiths and are ready to fight these monsters in the mines of Moria"]]},
{intro:"So now we have to go and adapt to getting the thing our character is after.",examples:[["Finding Nemo","Marlin and Dory trust the turtles and swim through the chaos of the EAC"],["The Lion King","Simba is hunting bugs in the jungle by himself. Simba grows up with no worries"],["Star Wars","Luke finds the Princess's prison cell"],["Gladiator","Maximus has to gather a new team of men if he's going to survive the intense arena in the heart of Rome"],["Aladdin","Aladdin shows Jasmine a whole new world"],["Lord of the Rings","The Fellowship is succeeding in battle and nearing the exit of the mines"]]},
{intro:"Here is where your protagonist should get exactly what they're after.",examples:[["Finding Nemo","Marlin and Dory get to open water!"],["The Lion King","Simba meets up with a lioness from his old pride and gets all her love and attention without having to deal with any negativity from his past"],["Star Wars","Luke frees Princess Leia from her cell!"],["Gladiator","Maximus reveals himself to the emperor"],["Aladdin","Aladdin gets a kiss from Jasmine!"],["Lord of the Rings","The Fellowship makes the goblins retreat!"]]},
{intro:"And what do they have to pay for when they get this reward?",details:"We aren't yet to the \"Pay\" section, remember. It's just got to be a quick dose of reality for what life will be like after getting what you sought. Maybe your protagonist who just got that dream job sees that the hours are actually insane—but they're still excited about the job.",examples:[["Finding Nemo","Marlin and Dory have to decide to take a ride in the mouth of a pelican to get all the way to the dentist's office"],["The Lion King","Simba is bested in a physical confrontation by Nala. While this happens before he fully gets her, the beat still exists. He isn't paying full price just yet"],["Star Wars","Luke just gets a quick insult thrown at him by the princess: \"Aren't you a little short for a stormtrooper?\""],["Gladiator","Maximus was so close to being able to kill the emperor but was unarmed and out of range"],["Aladdin","Aladdin is presented to the entire population of the city with the context that he will become sultan—and is overwhelmed by the idea"]]},
{intro:"Here they are changed. Usually they are at the top of their confidence and can take a moment to absorb the big win. This is the biggest peak of the movie so far.",examples:[["Finding Nemo","Marlin and Dory are riding through a flock of seagulls while inside the mouth of a pelican!"],["The Lion King","Simba and Nala can feel the love"],["Star Wars","Luke is confident in the rescue"],["Gladiator","Maximus has the emperor's attention"],["Aladdin","Aladdin sees the whole city cheering for him!"]]}
],
6:[
{intro:"So who is our protagonist now? A cocky big shot? One of the popular girls?",details:"Things are still looking pretty good here.",examples:[["Finding Nemo","Marlin and Dory get to the dentist's office!"],["The Lion King","Simba tries to convince Nala to stay with him"],["Star Wars","The rescue continues, but it's getting rough"],["Gladiator","Maximus is a crowd favorite"],["Aladdin","Aladdin is riding high"],["Lord of the Rings","The Fellowship is looking good having made it all the way to the Bridge of Khazad-dûm"]]},
{intro:"What is the \"go and adapt\" here?",examples:[["Finding Nemo","Marlin watches the absolute chaos of the dentist's office unfold and thinks Nemo is dead"],["The Lion King","Nala confronts Simba—things are bad at home"],["Star Wars","Luke and company are nearly killed by the monster in the trash compactor"],["Gladiator","The emperor plots against Maximus"],["Aladdin","Aladdin loses the lamp and it's stolen by Jafar"],["Lord of the Rings","The Fellowship has crossed the bridge, but Gandalf stays back to fight the Balrog"]]},
{intro:"And what do our protagonists get? They get to PAY.",examples:[["Finding Nemo","Marlin and Dory are pushed out of the office, unable to see that Nemo was playing dead—unable to complete their rescue"],["The Lion King","Simba's guilt intensifies as Nala leaves"],["Star Wars","Obi-Wan is killed"],["Gladiator","Maximus sees his plot foiled and his allies murdered"],["Aladdin","Jafar now gets to use the lamp and wish himself to be the most powerful sorcerer in the world! Aladdin and everything he has worked for is now reversed and destroyed"],["Lord of the Rings","The Fellowship sees Gandalf lose the fight against the Balrog"]]},
{intro:"Pay. The worst valley of the movie. A shadow of death.",details:"They're dealing with that huge loss. As much loss as possible without completely killing our protagonists. Our characters might even be thinking death would be preferable to what we have here.",examples:[["Finding Nemo","Marlin is so destroyed that he's abandoned Dory and is swimming aimlessly"],["The Lion King","With Nala gone, Simba has to sit with his cowardice and his actions"],["Star Wars","Luke is helpless and can do nothing to save, or avenge, Obi-Wan"],["Gladiator","Maximus sees his entire team get killed and he's captured by the emperor"],["Aladdin","Aladdin is thrown onto an icy mountainside"],["Lord of the Rings","The Fellowship is mourning on the mountainside and Aragorn has to push them onward"]]},
{intro:"They're now changed in such a way that they are forced to deal with the fact that if they are going to survive, they have to push forward without the mentor they just lost—the guide to the world they've been adapting to.",details:"They have to take all the knowledge they've learned from that mentor and reflect on it, reflect on the relationship they had and now lost.",question:"Who and what did your character just lose?",examples:[["Finding Nemo","Marlin swims on toward the fishing grounds"],["The Lion King","Simba reflects on his father's teachings"],["Star Wars","Luke processes Obi-Wan's death while Princess Leia wants to push the rebellion forward"],["Gladiator","Maximus prepares for his final fight"],["Aladdin","Aladdin takes responsibility"]]}
],
7:[
{intro:"Who is your character now?",details:"Now that your character has reflected on the relationship they've lost, they have also internalized all the things they've learned from it. What sort of person is your character now ready to return to their mission?",examples:[["Finding Nemo","First, we see Dory has grown. She's literally grown a memory. When she runs into Nemo she takes the reins and brings Nemo to Marlin. After this, we have to see Marlin grow and let his son take risks."],["The Lion King","Simba has noble obligations and the potential to make everything better back at Pride Rock—BUT he has to accept that responsibility. He heads back toward home when he comes across Rafiki the sage baboon who pushes him to do the right thing"],["Star Wars","Luke has to trust his feelings and knows that the Empire is even more dangerous since he has seen how powerful Vader is"],["Gladiator","Maximus is ready to sacrifice everything"],["Aladdin","Aladdin recognizes all this is his responsibility. It's his fault he didn't free the Genie on time, he lost the lamp, and Jafar is in power"],["Lord of the Rings","Aragorn has reflected upon the fact that without Gandalf, the Fellowship needs a leader"]]},
{intro:"Here your protagonist must go and start that return.",examples:[["Finding Nemo","This is told from Nemo's perspective where we have returned to a search, but Nemo is looking for his dad. This is where we find Dory and then brings Nemo to Marlin"],["The Lion King","The Pride Lands are arid and languishing. Hyenas are everywhere"],["Star Wars","Luke is now with the rebellion and another ally, Han Solo, is leaving him"],["Gladiator","Maximus prepares for the arena"],["Aladdin","Aladdin goes back to the palace that is now a twisted version of its old self. He has to adapt to the new environment and dangers"],["Lord of the Rings","Aragorn and the Fellowship return to the road and must adapt to the fact that they are being actively pursued by orcs"]]},
{intro:"What do they get on this return?",examples:[["Finding Nemo","Dory reunites Marlin with Nemo! Marlin is ready to return home"],["The Lion King","Simba sees his old pride of lions and learns of all their troubles"],["Star Wars","Luke rejoins the rebellion"],["Gladiator","Maximus enters the arena"],["Aladdin","Aladdin gets to see Jasmine is still alive"],["Lord of the Rings","The Fellowship has made it along the river and are making headway against the forces of evil!"]]},
{intro:"The payment of the Return. I've always felt like this is the REAL climax and the rest of the story from here forward is falling action.",question:"What part of your protagonist has been sacrificed so they can win this fight?",examples:[["Finding Nemo","Marlin, Nemo, and Dory are swept up by a fishing net with a ton of other fish. Marlin and Nemo escape, but Dory is too big and trapped. Marlin has to trust everything he has learned and let Nemo go off on his own—risking his prized son to death yet again—so that Nemo can free Dory and the other fish"],["The Lion King","Simba has to risk his life to save the kingdom he had abandoned and fight his murderous uncle"],["Star Wars","Luke attacks the Death Star with the other rebels and gets close enough to take the vital shot—but he chooses to turn off his targeting computer and use the Force as Obi-Wan taught him. He sacrifices his reputation AND the technological assurances that he would destroy the Empire with one shot"],["Gladiator","Maximus gets to fight the emperor in the gladiatorial arena, but has to pay with his own blood—Maximus is fatally stabbed before the fight begins so the emperor believes he will have a guaranteed win"],["Aladdin","Aladdin has to fight Jafar and take everything he has learned—Jafar's thirst for power, the Genie's bonds, his own strengths of wit and guile. He takes this knowledge to trick Jafar into imprisoning himself"],["Lord of the Rings","Aragorn and the Fellowship know they are being watched, tracked, and must accept that they must be the bait—allowing Frodo and Sam to continue alone if they're to have any hope of entering Mordor undetected. Here, the Fellowship takes a stand against the forces of evil so Frodo and Sam can escape"]]},
{intro:"They've made the choice and have returned to the arena.",question:"Who is your hero now?",examples:[["Finding Nemo","Marlin watches Nemo lead"],["The Lion King","Simba relies on his strength and courage to overthrow his power-hungry uncle"],["Star Wars","Luke takes the shot with his computer off!"],["Gladiator","Maximus fights the emperor and trusts that his example will lead Rome back to a free republic"],["Aladdin","Aladdin trusts that Jafar's wish will imprison him"]]}
],
8:[
{intro:"The fight is over and your character is the conquering hero—they've defeated their own problems and are ready to celebrate!",details:"They probably want a rest at this point."},
{intro:"So where do they go and what are they adapting to now?",details:"They're back home but they are a different person. Everyone in the village looks at them differently. They have to go about their day but adapt to being perceived as someone new.",examples:[["Finding Nemo","Marlin is ready to take Nemo to school but now he is ready to let Nemo venture out on his own—and Marlin himself has transformed into a funny clownfish!"],["The Lion King","Simba is seen as a strong king and he must walk among his subjects with that new power AND responsibility on his shoulders"],["Star Wars","Luke goes back to the rebellion—not as some punk kid from a distant planet, but as a hero and an ace pilot!"],["Gladiator","Maximus is departing to the Elysian Fields of the afterlife"],["Aladdin","Aladdin is now seen by Jasmine as the bold and courageous man she wants to marry rather than a fake prince"]]},
{intro:"What do they get?",details:"It might be a single line or it may be an entire award ceremony.",examples:[["Finding Nemo","Marlin gets a hug from Nemo and Nemo says \"I love you, Dad.\" This is an EXACT inversion and bookend of when they departed for school in the beginning and Nemo said \"I hate you\""],["The Lion King","Simba is a king and the Pride Lands have returned to their lush and fruitful ways"],["Star Wars","Luke and Han and Chewy and Princess Leia are the focus of a HUGE award celebration among the top of the rebel forces"],["Gladiator","Maximus is reunited with his family in death"],["Aladdin","Aladdin is also about to become a king"]]},
{intro:"Is there still more payment to be had?",examples:[["Finding Nemo","Marlin still has to watch Nemo leave, but this time with confidence"],["The Lion King","Simba is now a dad and it's implied he will have to deal with the same rebellious spirit in his son that he had in his own youth"],["Star Wars","The war continues with Luke as a Jedi in training on their side"],["Gladiator","Maximus's sacrifice inspires Rome"],["Aladdin","Aladdin has to rely on himself to rule as sultan and must set the Genie free"],["Lord of the Rings","The Fellowship is broken but Aragorn is confident his new leadership will be an even better hope and help for Frodo and Sam. Frodo and Sam return to their long road to Mordor without the direct companionship of their friends"]]},
{intro:"Here your protagonist should be comfortable in their new skin.",details:"Or, if it's a tragedy, they have NOT changed and the whole world around them has changed and crumbled. But this is basically your opening—with your character in a new light.",question:"What's the closing image you want us to see of your protagonist and their new world?",examples:[["Finding Nemo","Marlin's home is safe and happy again"],["The Lion King","The Pride Lands are restored"],["Star Wars","The rebellion has new hope"],["Gladiator","Maximus is reunited with his wife (in the afterlife)"],["Aladdin","Aladdin will rule justly"],["Lord of the Rings","There are now three new fellowships who are each doing their own part to destroy the ring—Sam and Frodo are sneaking to Mordor, Aragorn and Gimli and Legolas are hunting orcs and gathering information while tracking Merry and Pippin who are doing their best to fool the forces of evil into thinking they have the ring"]]}
]
};


/* ============================================
   STORAGE LAYER
   ============================================ */
const Storage = {
    SCRIPTS_KEY: 'stsf_scripts_v2',
    ONBOARDING_KEY: 'stsf_onboarding_seen',
    BACKUP_KEY: 'stsf_last_backup',
    SAVES_KEY: 'stsf_saves_since_backup',

    getAll() {
        try {
            const data = localStorage.getItem(this.SCRIPTS_KEY);
            return data ? JSON.parse(data) : {};
        } catch (e) { return {}; }
    },

    saveAll(scripts) {
        localStorage.setItem(this.SCRIPTS_KEY, JSON.stringify(scripts));
        this.incrementSaves();
    },

    get(id) {
        return this.getAll()[id] || null;
    },

    save(id, data) {
        const all = this.getAll();
        all[id] = { ...all[id], ...data, lastModified: new Date().toISOString() };
        this.saveAll(all);
    },

    remove(id) {
        const all = this.getAll();
        delete all[id];
        this.saveAll(all);
    },

    generateId() {
        return 'script_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    },

    hasSeenOnboarding() {
        return localStorage.getItem(this.ONBOARDING_KEY) === 'true';
    },

    setOnboardingSeen() {
        localStorage.setItem(this.ONBOARDING_KEY, 'true');
    },

    // Backup tracking
    recordBackup() {
        localStorage.setItem(this.BACKUP_KEY, new Date().toISOString());
        localStorage.setItem(this.SAVES_KEY, '0');
    },

    getLastBackup() {
        return localStorage.getItem(this.BACKUP_KEY);
    },

    getSavesSinceBackup() {
        return parseInt(localStorage.getItem(this.SAVES_KEY) || '0', 10);
    },

    incrementSaves() {
        const current = this.getSavesSinceBackup();
        localStorage.setItem(this.SAVES_KEY, String(current + 1));
    },

    shouldRemindBackup() {
        return this.getSavesSinceBackup() >= 15;
    },

    // Migrate from v1 data format if present
    migrateV1() {
        const oldKey = 'screenplay_workbook_scripts';
        const oldData = localStorage.getItem(oldKey);
        if (oldData && !localStorage.getItem(this.SCRIPTS_KEY)) {
            try {
                const parsed = JSON.parse(oldData);
                localStorage.setItem(this.SCRIPTS_KEY, JSON.stringify(parsed));
                this.setOnboardingSeen();
            } catch(e) {}
        }
    }
};


/* ============================================
   APP CONTROLLER
   ============================================ */
const App = {
    currentScriptId: null,
    currentSection: null,
    currentScenePage: 1,
    saveTimeout: null,
    SCENES_PER_PAGE: 5,

    init() {
        Storage.migrateV1();
        this.setupModalClicks();
        this.setupImportListener();
        this.setupKeyboardShortcuts();
        this.setupBeforeUnload();

        if (!Storage.hasSeenOnboarding() && Object.keys(Storage.getAll()).length === 0) {
            this.showScreen('onboarding');
        } else {
            this.showScreen('dashboard');
        }
    },

    // --- Beforeunload warning ---
    hasUnsavedWork: false,

    setupBeforeUnload() {
        window.addEventListener('beforeunload', (e) => {
            if (this.hasUnsavedWork) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    },

    // --- Screen management ---
    showScreen(name) {
        document.getElementById('screenOnboarding').style.display = name === 'onboarding' ? 'flex' : 'none';
        document.getElementById('screenDashboard').style.display = name === 'dashboard' ? 'block' : 'none';
        const wb = document.getElementById('screenWorkbook');
        if (name === 'workbook') { wb.classList.add('active'); } else { wb.classList.remove('active'); }
        if (name === 'dashboard') this.renderDashboard();
    },

    dismissOnboarding() {
        Storage.setOnboardingSeen();
        this.showScreen('dashboard');
    },

    // --- Dashboard ---
    renderDashboard() {
        const scripts = Storage.getAll();
        const container = document.getElementById('scriptsContainer');
        const ids = Object.keys(scripts).sort((a, b) =>
            new Date(scripts[b].lastModified) - new Date(scripts[a].lastModified)
        );

        if (ids.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📝</div><h3>No scripts yet</h3><p>Start your first screenplay journey.</p></div>';
            return;
        }

        container.innerHTML = '<div class="scripts-list">' + ids.map(id => {
            const s = scripts[id];
            const progress = this.calculateProgress(s);
            const phase = this.getPhase(progress);
            const lastMod = new Date(s.lastModified).toLocaleDateString();
            return `<div class="script-card" onclick="App.openScript('${id}')">
                <div class="script-card-top">
                    <div class="script-card-title">${this.esc(s.title || 'Untitled Script')}</div>
                    <button class="script-card-menu" onclick="event.stopPropagation(); App.showDeleteConfirm('${id}', '${this.esc(s.title || 'Untitled Script')}');" aria-label="Delete script">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="5" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="19" r="1.5"/></svg>
                    </button>
                </div>
                <div class="script-card-meta">Last edited ${lastMod}</div>
                <div class="script-card-progress-track"><div class="script-card-progress-bar" style="width:${progress}%"></div></div>
                <div class="script-card-footer">
                    <span class="script-card-phase">${phase}</span>
                    <span class="script-card-percent">${progress}%</span>
                </div>
            </div>`;
        }).join('') + '</div>';
    },

    calculateProgress(script) {
        if (!script || !script.fields) return 0;
        const f = script.fields;
        let filled = 0, total = 0;
        const fields = ['title','logline1','logline2','logline3','logline4','logline5','loglineFinal',
            'circle1','circle2','circle3','circle4','circle5','circle6','circle7','circle8'];
        ['varA','varB','varC','finalCircle'].forEach(p => { for(let i=1;i<=8;i++) fields.push(p+i); });
        for(let i=1;i<=8;i++) for(let j=1;j<=5;j++) { fields.push('forty_'+i+'_'+j); fields.push('fortyRevise_'+i+'_'+j); }
        for(let i=1;i<=40;i++) fields.push('scene_'+i);
        fields.push('celebrationNote');
        total = fields.length;
        fields.forEach(field => { if(f[field] && f[field].trim().length > 0) filled++; });
        return Math.round((filled / total) * 100);
    },

    getPhase(progress) {
        if (progress < 15) return 'Phase 1: Foundation';
        if (progress < 30) return 'Phase 2: Structure';
        if (progress < 95) return 'Phase 3: Writing';
        return 'Complete';
    },

    // --- Script CRUD ---
    createNewScript() {
        document.getElementById('newScriptTitle').value = '';
        this.openModal('newScriptModal');
        setTimeout(() => document.getElementById('newScriptTitle').focus(), 200);
    },

    confirmNewScript() {
        const title = document.getElementById('newScriptTitle').value.trim() || 'Untitled Script';
        const id = Storage.generateId();
        Storage.save(id, { id, title, created: new Date().toISOString(), fields: { title } });
        this.closeModal('newScriptModal');
        this.openScript(id);
    },

    openScript(id) {
        this.currentScriptId = id;
        const script = Storage.get(id);
        document.getElementById('topbarTitle').textContent = script.title || 'Untitled Script';
        this.showScreen('workbook');
        this.buildSidebar();
        this.buildMobileNav();
        this.navigateTo('logline');
    },

    goToDashboard() {
        this.currentScriptId = null;
        this.currentSection = null;
        this.showScreen('dashboard');
    },

    scriptToDelete: null,

    showDeleteConfirm(id, title) {
        this.scriptToDelete = id;
        document.getElementById('deleteScriptName').textContent = title;
        this.openModal('deleteModal');
    },

    confirmDelete() {
        if (this.scriptToDelete) {
            Storage.remove(this.scriptToDelete);
            this.scriptToDelete = null;
            this.closeModal('deleteModal');
            this.renderDashboard();
        }
    },

    // --- Navigation ---
    buildSidebar() {
        const sidebar = document.getElementById('workbookSidebar');
        let html = `<div class="sidebar-progress-block">
            <div class="sidebar-progress-label"><span>Progress</span><span id="sidebarPercent">0%</span></div>
            <div class="sidebar-progress-track"><div class="sidebar-progress-fill" id="sidebarProgressFill" style="width:0%"></div></div>
        </div>`;

        let currentPhase = '';
        CONTENT.nav.forEach(item => {
            if (item.phase !== currentPhase) {
                currentPhase = item.phase;
                html += `<div class="sidebar-phase">${item.phase}</div>`;
            }
            html += `<button class="sidebar-nav-item" data-section="${item.id}" onclick="App.navigateTo('${item.id}')">
                <span class="nav-check">✓</span>
                <span>Day ${item.day}: ${item.label}</span>
            </button>`;
        });
        sidebar.innerHTML = html;
    },

    buildMobileNav() {
        const nav = document.getElementById('mobileNavInner');
        nav.innerHTML = CONTENT.nav.map(item =>
            `<button class="mobile-nav-btn" data-section="${item.id}" onclick="App.navigateTo('${item.id}')">
                ${CONTENT.mobileNavIcons[item.icon]}
                <span>${item.label}</span>
                <span class="nav-dot"></span>
            </button>`
        ).join('');
    },

    navigateTo(sectionId) {
        this.currentSection = sectionId;
        if (sectionId === 'scenes') this.currentScenePage = 1;

        const mainContent = document.getElementById('mainContent');
        mainContent.innerHTML = '<div class="section-enter">' + this.renderSection(sectionId) + '</div>';

        // Highlight nav
        document.querySelectorAll('.sidebar-nav-item').forEach(n => n.classList.remove('active'));
        document.querySelectorAll('.mobile-nav-btn').forEach(n => n.classList.remove('active'));
        const sidebarItem = document.querySelector(`.sidebar-nav-item[data-section="${sectionId}"]`);
        const mobileItem = document.querySelector(`.mobile-nav-btn[data-section="${sectionId}"]`);
        if (sidebarItem) sidebarItem.classList.add('active');
        if (mobileItem) mobileItem.classList.add('active');

        this.loadFields();
        this.setupAutosave();
        this.updateProgress();

        // Scroll to top — target the scrollable container
        const mainEl = document.getElementById('workbookMain');
        mainEl.scrollTo({ top: 0, behavior: 'instant' });
        // Fallback for iOS Safari
        window.scrollTo({ top: 0, behavior: 'instant' });
    },

    // --- Section Rendering ---
    renderSection(id) {
        const renderer = SECTIONS[id];
        return renderer ? renderer() : '<p>Section not found.</p>';
    },

    // --- Field management ---
    loadFields() {
        const script = Storage.get(this.currentScriptId);
        if (!script || !script.fields) return;

        document.querySelectorAll('[data-field]').forEach(input => {
            const field = input.getAttribute('data-field');
            input.value = script.fields[field] || '';
        });

        document.querySelectorAll('[data-reference]').forEach(box => {
            const refField = box.getAttribute('data-reference');
            const content = box.querySelector('.scene-reference-content');
            if (content) {
                content.textContent = (script.fields[refField] && script.fields[refField].trim())
                    ? script.fields[refField]
                    : 'Complete Day 5 to see your scene outline here.';
            }
        });
    },

    setupAutosave() {
        document.querySelectorAll('[data-field]').forEach(input => {
            input.addEventListener('input', (e) => {
                this.hasUnsavedWork = true;
                this.showSaveState('saving');
                clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(() => {
                    this.saveField(e.target);
                    this.showSaveState('saved');
                    this.hasUnsavedWork = false;
                    this.updateProgress();
                    this.checkBackupReminder();
                }, 400);
            });
        });
    },

    saveField(input) {
        const field = input.getAttribute('data-field');
        const value = input.value;
        const script = Storage.get(this.currentScriptId);
        if (!script.fields) script.fields = {};
        script.fields[field] = value;
        if (field === 'title') {
            script.title = value || 'Untitled Script';
            document.getElementById('topbarTitle').textContent = script.title;
        }
        Storage.save(this.currentScriptId, script);
    },

    showSaveState(state) {
        const el = document.getElementById('topbarSave');
        el.className = 'topbar-save ' + state;
        el.textContent = state === 'saving' ? 'Saving...' : 'All changes saved';
    },

    updateProgress() {
        const script = Storage.get(this.currentScriptId);
        const progress = this.calculateProgress(script);
        const percent = progress + '%';

        const sidebarPercent = document.getElementById('sidebarPercent');
        const sidebarFill = document.getElementById('sidebarProgressFill');
        const mobileFill = document.getElementById('mobileProgressFill');

        if (sidebarPercent) sidebarPercent.textContent = percent;
        if (sidebarFill) sidebarFill.style.width = percent;
        if (mobileFill) mobileFill.style.width = percent;
    },

    // --- Scene pagination ---
    goToScenePage(page) {
        this.currentScenePage = page;
        this.navigateTo('scenes');
    },

    // --- Modals ---
    openModal(id) { document.getElementById(id).classList.add('active'); },
    closeModal(id) { document.getElementById(id).classList.remove('active'); },

    setupModalClicks() {
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.classList.remove('active');
            });
        });
    },

    // --- Settings ---
    showSettings() {
        const script = Storage.get(this.currentScriptId);
        document.getElementById('settingsTitle').value = script.title || '';

        // Update backup info
        const backupInfo = document.getElementById('backupInfo');
        const lastBackup = Storage.getLastBackup();
        const savesSince = Storage.getSavesSinceBackup();
        if (lastBackup) {
            const date = new Date(lastBackup).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' });
            backupInfo.innerHTML = `<strong>Last backup:</strong> ${date}<br>${savesSince > 0 ? `<span class="${savesSince > 10 ? 'backup-warning' : ''}">${savesSince} saves since last backup.</span>` : 'Up to date.'}`;
        } else {
            backupInfo.innerHTML = `<strong>No backups yet.</strong> <span class="backup-warning">Export your work to keep it safe.</span>`;
        }

        this.openModal('settingsModal');
    },

    saveSettings() {
        const newTitle = document.getElementById('settingsTitle').value.trim() || 'Untitled Script';
        const script = Storage.get(this.currentScriptId);
        script.title = newTitle;
        if (script.fields) script.fields.title = newTitle;
        Storage.save(this.currentScriptId, script);
        document.getElementById('topbarTitle').textContent = newTitle;
        this.closeModal('settingsModal');
    },

    // --- Export / Import ---
    exportAllData() {
        const scripts = Storage.getAll();
        this.downloadJSON(scripts, 'screenplay_workbook_backup_' + new Date().toISOString().split('T')[0]);
        Storage.recordBackup();
        this.showToast('Backup exported successfully ✓');
    },

    exportCurrentScript() {
        const script = Storage.get(this.currentScriptId);
        const safeName = (script.title || 'script').replace(/[^a-z0-9]/gi, '_').toLowerCase();
        this.downloadJSON(script, safeName + '_' + new Date().toISOString().split('T')[0]);
        Storage.recordBackup();
        this.closeModal('settingsModal');
        this.showToast('Script exported successfully ✓');
    },

    downloadJSON(data, filename) {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename + '.json';
        a.click();
        URL.revokeObjectURL(url);
    },

    importData() { document.getElementById('importInput').click(); },

    setupImportListener() {
        document.getElementById('importInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const data = JSON.parse(evt.target.result);
                    if (data.id && data.fields) {
                        const newId = Storage.generateId();
                        data.id = newId;
                        Storage.save(newId, data);
                    } else {
                        const existing = Storage.getAll();
                        Object.keys(data).forEach(id => {
                            const newId = Storage.generateId();
                            data[id].id = newId;
                            existing[newId] = data[id];
                        });
                        Storage.saveAll(existing);
                    }
                    Storage.setOnboardingSeen();
                    this.showScreen('dashboard');
                } catch (err) {
                    alert('Error importing file. Please check the format.');
                    console.error(err);
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        });
    },

    setupKeyboardShortcuts() {
        document.getElementById('newScriptTitle').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.confirmNewScript();
        });
    },

    // --- Toast notifications ---
    showToast(message, action, actionCallback) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerHTML = message;
        if (action && actionCallback) {
            const btn = document.createElement('button');
            btn.className = 'toast-action';
            btn.textContent = action;
            btn.onclick = () => { actionCallback(); toast.remove(); };
            toast.appendChild(btn);
        }
        container.appendChild(toast);
        setTimeout(() => { if (toast.parentNode) toast.remove(); }, 5000);
    },

    // --- Backup reminder ---
    checkBackupReminder() {
        if (Storage.shouldRemindBackup()) {
            this.showToast('You have unsaved work. Back up your scripts!', 'Export Now', () => {
                this.exportAllData();
            });
            // Reset counter so we don't spam
            localStorage.setItem(Storage.SAVES_KEY, '0');
        }
    },

    // --- Collapsible 40-point groups ---
    toggleFortyGroup(el) {
        const group = el.closest('.forty-point-group');
        if (group) group.classList.toggle('collapsed');
    },

    // --- Section export bar HTML ---
    exportBar() {
        return `<div class="section-export">
            <span class="section-export-label">Save a copy of your work</span>
            <button class="btn btn-secondary btn-sm" onclick="App.exportWorkbookDocx()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Download .docx
            </button>
        </div>`;
    },

    // --- DOCX export (fully self-contained, no external libraries) ---
    // A .docx is a ZIP containing XML files. We build it from scratch.

    async exportWorkbookDocx() {
        const script = Storage.get(this.currentScriptId);
        if (!script || !script.fields) {
            this.showToast('No content to export yet.');
            return;
        }

        const f = script.fields;
        const title = f.title || 'Untitled Script';
        const storyPointNames = ['CHARACTER','WANT','GO','ADAPT','GET','PAY','RETURN','CHANGED'];

        // Build document XML content
        let bodyXml = '';

        const esc = (s) => s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : '';

        const addTitle = (text) => {
            bodyXml += `<w:p><w:pPr><w:pStyle w:val="Title"/><w:jc w:val="center"/></w:pPr><w:r><w:rPr><w:b/><w:sz w:val="56"/></w:rPr><w:t>${esc(text)}</w:t></w:r></w:p>`;
        };

        const addSubtitle = (text) => {
            bodyXml += `<w:p><w:pPr><w:jc w:val="center"/></w:pPr><w:r><w:rPr><w:i/><w:color w:val="666666"/><w:sz w:val="24"/></w:rPr><w:t>${esc(text)}</w:t></w:r></w:p>`;
        };

        const addHeading = (text, level) => {
            const style = level === 2 ? 'Heading2' : 'Heading1';
            bodyXml += `<w:p><w:pPr><w:pStyle w:val="${style}"/><w:spacing w:before="360" w:after="120"/></w:pPr><w:r><w:rPr><w:b/></w:rPr><w:t>${esc(text)}</w:t></w:r></w:p>`;
        };

        const addField = (label, value) => {
            if (!value || !value.trim()) return;
            // Split on newlines for multi-paragraph fields
            const lines = value.trim().split(/\n/);
            bodyXml += `<w:p><w:pPr><w:spacing w:after="80"/></w:pPr><w:r><w:rPr><w:b/><w:sz w:val="22"/></w:rPr><w:t xml:space="preserve">${esc(label)}: </w:t></w:r><w:r><w:rPr><w:sz w:val="22"/></w:rPr><w:t>${esc(lines[0])}</w:t></w:r></w:p>`;
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    bodyXml += `<w:p><w:pPr><w:spacing w:after="80"/></w:pPr><w:r><w:rPr><w:sz w:val="22"/></w:rPr><w:t>${esc(lines[i])}</w:t></w:r></w:p>`;
                }
            }
        };

        const addPara = (text) => {
            if (!text || !text.trim()) return;
            text.trim().split(/\n/).forEach(line => {
                if (line.trim()) {
                    bodyXml += `<w:p><w:pPr><w:spacing w:after="120"/></w:pPr><w:r><w:rPr><w:sz w:val="22"/></w:rPr><w:t>${esc(line)}</w:t></w:r></w:p>`;
                }
            });
        };

        const addSpacer = () => {
            bodyXml += `<w:p><w:pPr><w:spacing w:after="200"/></w:pPr></w:p>`;
        };

        let hasContent = false;

        // Title
        addTitle(title);
        addSubtitle('Story from Start to Finish');
        addSpacer();

        // Loglines
        const hasLoglines = [1,2,3,4,5].some(i => f['logline'+i] && f['logline'+i].trim()) || (f.loglineFinal && f.loglineFinal.trim());
        if (hasLoglines) {
            hasContent = true;
            addHeading('Logline Development');
            for (let i = 1; i <= 5; i++) addField('Logline ' + i, f['logline' + i]);
            addField('Chosen Logline', f.loglineFinal);
            addSpacer();
        }

        // Story Circle
        const hasCircle = [1,2,3,4,5,6,7,8].some(i => f['circle'+i] && f['circle'+i].trim());
        if (hasCircle) {
            hasContent = true;
            addHeading('Story Circle');
            for (let i = 1; i <= 8; i++) addField(storyPointNames[i-1], f['circle' + i]);
            addSpacer();
        }

        // Variations
        ['A','B','C'].forEach(v => {
            const has = [1,2,3,4,5,6,7,8].some(i => f['var'+v+i] && f['var'+v+i].trim());
            if (has) {
                hasContent = true;
                addHeading('Variation ' + v, 2);
                for (let i = 1; i <= 8; i++) addField(storyPointNames[i-1], f['var' + v + i]);
            }
        });
        const hasFinal = [1,2,3,4,5,6,7,8].some(i => f['finalCircle'+i] && f['finalCircle'+i].trim());
        if (hasFinal) {
            hasContent = true;
            addHeading('Final Story Circle', 2);
            for (let i = 1; i <= 8; i++) addField(storyPointNames[i-1], f['finalCircle' + i]);
            addSpacer();
        }

        // 40 Points
        let hasForty = false;
        for (let g = 1; g <= 8; g++) {
            const has = [1,2,3,4,5].some(j => f['forty_'+g+'_'+j] && f['forty_'+g+'_'+j].trim());
            if (has) {
                if (!hasForty) { addHeading('The 40 Points'); hasForty = true; hasContent = true; }
                addHeading(g + '. ' + storyPointNames[g-1], 2);
                for (let j = 1; j <= 5; j++) {
                    const sn = (g-1)*5+j;
                    addField('Scene ' + sn, f['forty_'+g+'_'+j]);
                }
            }
        }
        if (hasForty) addSpacer();

        // Revised 40
        let hasRevised = false;
        for (let g = 1; g <= 8; g++) {
            const has = [1,2,3,4,5].some(j => f['fortyRevise_'+g+'_'+j] && f['fortyRevise_'+g+'_'+j].trim());
            if (has) {
                if (!hasRevised) { addHeading('Revised 40 Points'); hasRevised = true; hasContent = true; }
                addHeading(g + '. ' + storyPointNames[g-1], 2);
                for (let j = 1; j <= 5; j++) {
                    const sn = (g-1)*5+j;
                    addField('Scene ' + sn, f['fortyRevise_'+g+'_'+j]);
                }
            }
        }
        if (hasRevised) addSpacer();

        // Scenes
        let hasScenes = false;
        for (let i = 1; i <= 40; i++) {
            if (f['scene_'+i] && f['scene_'+i].trim()) {
                if (!hasScenes) { addHeading('Scenes'); hasScenes = true; hasContent = true; }
                const sp = Math.ceil(i/5);
                addHeading('Scene ' + i + ' — ' + storyPointNames[sp-1], 2);
                addPara(f['scene_'+i]);
            }
        }

        // Celebration
        if (f.celebrationNote && f.celebrationNote.trim()) {
            hasContent = true;
            addHeading('Celebration Note');
            addPara(f.celebrationNote);
        }

        if (!hasContent) {
            this.showToast('No content to export yet.');
            return;
        }

        // Assemble the .docx XML files
        const documentXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:wpc="http://schemas.microsoft.com/office/word/2010/wordprocessingCanvas" xmlns:mo="http://schemas.microsoft.com/office/mac/office/2008/main" xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" xmlns:mv="urn:schemas-microsoft-com:mac:vml" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships" xmlns:m="http://schemas.openxmlformats.org/officeDocument/2006/math" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:wp14="http://schemas.microsoft.com/office/word/2010/wordprocessingDrawing" xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing" xmlns:w10="urn:schemas-microsoft-com:office:word" xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main" xmlns:w14="http://schemas.microsoft.com/office/word/2010/wordml" xmlns:wpg="http://schemas.microsoft.com/office/word/2010/wordprocessingGroup" xmlns:wpi="http://schemas.microsoft.com/office/word/2010/wordprocessingInk" xmlns:wne="http://schemas.microsoft.com/office/word/2006/wordml" xmlns:wps="http://schemas.microsoft.com/office/word/2010/wordprocessingShape" mc:Ignorable="w14 wp14">
<w:body>
${bodyXml}
<w:sectPr><w:pgSz w:w="12240" w:h="15840"/><w:pgMar w:top="1440" w:right="1440" w:bottom="1440" w:left="1440" w:header="720" w:footer="720" w:gutter="0"/></w:sectPr>
</w:body>
</w:document>`;

        const stylesXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
<w:docDefaults><w:rPrDefault><w:rPr><w:rFonts w:ascii="Arial" w:hAnsi="Arial" w:cs="Arial"/><w:sz w:val="24"/></w:rPr></w:rPrDefault></w:docDefaults>
<w:style w:type="paragraph" w:styleId="Title"><w:name w:val="Title"/><w:pPr><w:jc w:val="center"/></w:pPr><w:rPr><w:b/><w:sz w:val="56"/></w:rPr></w:style>
<w:style w:type="paragraph" w:styleId="Heading1"><w:name w:val="heading 1"/><w:pPr><w:spacing w:before="360" w:after="120"/><w:outlineLvl w:val="0"/></w:pPr><w:rPr><w:b/><w:sz w:val="36"/></w:rPr></w:style>
<w:style w:type="paragraph" w:styleId="Heading2"><w:name w:val="heading 2"/><w:pPr><w:spacing w:before="240" w:after="80"/><w:outlineLvl w:val="1"/></w:pPr><w:rPr><w:b/><w:sz w:val="28"/></w:rPr></w:style>
</w:styles>`;

        const relsXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`;

        const wordRelsXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
</Relationships>`;

        const contentTypesXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
<Default Extension="xml" ContentType="application/xml"/>
<Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
<Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>
</Types>`;

        // Build ZIP using raw binary construction
        try {
            const zip = new MiniZip();
            zip.addFile('[Content_Types].xml', contentTypesXml);
            zip.addFile('_rels/.rels', relsXml);
            zip.addFile('word/document.xml', documentXml);
            zip.addFile('word/styles.xml', stylesXml);
            zip.addFile('word/_rels/document.xml.rels', wordRelsXml);

            const blob = zip.toBlob('application/vnd.openxmlformats-officedocument.wordprocessingml.document');
            const safeName = title.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${safeName}_workbook.docx`;
            a.click();
            URL.revokeObjectURL(url);
            Storage.recordBackup();
            this.showToast('Workbook downloaded ✓');
        } catch(err) {
            console.error('Export error:', err);
            this.showToast('Export failed. Try again.');
        }
    },

    // --- Utilities ---
    esc(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML.replace(/'/g, '&#39;');
    },

    prevSection() {
        const idx = CONTENT.nav.findIndex(n => n.id === this.currentSection);
        if (idx > 0) this.navigateTo(CONTENT.nav[idx - 1].id);
    },

    nextSection() {
        const idx = CONTENT.nav.findIndex(n => n.id === this.currentSection);
        if (idx < CONTENT.nav.length - 1) this.navigateTo(CONTENT.nav[idx + 1].id);
    },
};


/* ============================================
   SECTION RENDERERS
   Each returns HTML string
   ============================================ */
const SECTIONS = {
    logline() {
        return `<div class="section-header">
            <div class="section-phase">Day 1 · Phase 1</div>
            <h2 class="section-title">Logline Development</h2>
            <p class="section-subtitle">Spend at least 2 hours crafting the foundation of your story.</p>
        </div>
        <div class="content-block">
            <h3>The Purpose</h3>
            <p>Today you're going to jam your wild and creative ideas into a tiny mold. The entire purpose is to get your reps in—do the prescribed work and have a draft completed.</p>
            <p>If you HATE the results? Great news! It means you're closer to knowing exactly what SHOULD be in your story. If you LOVE them? Even better—you'll be ready to tear through with a red pen later.</p>
        </div>
        <div class="content-block">
            <h3>The Formula</h3>
            <div class="formula-box"><strong>TITLE</strong> is about a <strong>CHARACTER</strong> who <strong>DOES THEIR NORMAL STUFF</strong>, until one day <strong>SOMETHING DISRUPTS THE NORMALCY</strong> and now Character must <strong>ACHIEVE OBJECTIVE</strong> before <strong>STAKES</strong>.</div>
        </div>
        <div class="content-block">
            <h3>Examples to Study</h3>
            ${CONTENT.loglineExamples.map(ex => `<div class="example-box">
                <div class="example-box-title">${ex.title}</div>
                <p>${ex.text}</p>
                ${ex.detail ? `<p style="font-size:0.85rem;color:var(--text-muted);margin-top:8px;">${ex.detail}</p>` : ''}
            </div>`).join('')}
        </div>
        <div class="content-block">
            <h3>Your Loglines</h3>
            <p>Write at least FIVE versions. Make them as wildly different from each other as possible—they'll be similar since it's the same story, but push yourself.</p>
            <div class="input-group"><label class="input-label">Script Title</label><input type="text" data-field="title" placeholder="Your screenplay's working title"></div>
            ${[1,2,3,4,5].map(i => `<div class="input-group"><label class="input-label">Logline Version ${i}</label><textarea class="large" data-field="logline${i}" placeholder="${['Your first logline attempt...','Try a different angle...','What if you emphasized different stakes?','Try focusing on a different character trait...','One more wildly different take...'][i-1]}"></textarea></div>`).join('')}
            <div class="input-group"><label class="input-label">Your Chosen Logline</label><p class="input-hint">After writing all five, combine the best elements into your final version.</p><textarea class="large" data-field="loglineFinal" placeholder="Your refined, final logline..."></textarea></div>
        </div>
        ${App.exportBar()}
        <div class="section-nav"><div></div><button class="btn btn-primary" onclick="App.nextSection()">Continue to Day 2 →</button></div>`;
    },

    storycircle() {
        return `<div class="section-header">
            <div class="section-phase">Day 2 · Phase 1</div>
            <h2 class="section-title">Story Circle: 8 Points</h2>
            <p class="section-subtitle">Map your story's complete emotional journey.</p>
        </div>
        <div class="content-block">
            <h3>Why 5 Acts, Not 3</h3>
            <p>People love to talk about three-act structure. But then they talk about Act 2A and 2B, midpoints, and twists that "don't count" as act breaks.</p>
            <p>I work in 5 acts. Five solid points where characters literally can't go back. Slam the door and lock it behind them. Throw them down a hole! If your character forgets the turkey and remembers after crossing the bridge—<em>blow up that bridge.</em></p>
        </div>
        <div class="content-block">
            <h3>The Eight Points</h3>
            <p>These map to your five acts and give you the complete arc.</p>
            <div class="story-circle-grid">
                ${CONTENT.storyCirclePoints.map(p => `<div class="story-point">
                    <div class="story-point-header"><div class="story-point-number">${p.num}</div><div class="story-point-title">${p.title}</div></div>
                    <p class="input-hint">${p.hint}</p>
                    <textarea data-field="circle${p.num}" placeholder=""></textarea>
                </div>`).join('')}
            </div>
            <div class="tip-box"><div class="tip-box-title">Act Mapping</div><p><strong>Act 1:</strong> Character + Want · <strong>Act 2:</strong> Go + Adapt · <strong>Act 3:</strong> Get · <strong>Act 4:</strong> Pay · <strong>Act 5:</strong> Return + Changed</p></div>
        </div>
        ${App.exportBar()}
        <div class="section-nav"><button class="btn btn-secondary" onclick="App.prevSection()">← Day 1</button><button class="btn btn-primary" onclick="App.nextSection()">Continue to Day 3 →</button></div>`;
    },

    variations() {
        function variationGrid(prefix, hint) {
            const titles = ['CHARACTER','WANT','GO','ADAPT','GET','PAY','RETURN','CHANGED'];
            return `<p class="input-hint">${hint}</p><div class="story-circle-grid">${
                [1,2,3,4,5,6,7,8].map(i => `<div class="story-point">
                    <div class="story-point-header"><div class="story-point-number">${i}</div><div class="story-point-title">${titles[i-1]}</div></div>
                    <textarea data-field="${prefix}${i}" placeholder=""></textarea>
                </div>`).join('')
            }</div>`;
        }
        return `<div class="section-header">
            <div class="section-phase">Day 3 · Phase 1</div>
            <h2 class="section-title">Story Circle Variations</h2>
            <p class="section-subtitle">Explore three wildly different versions, then combine the best.</p>
        </div>
        <div class="content-block">
            <h3>The Exercise</h3>
            <p>Write three more drafts of your story circle, each WILDLY different from your Day 2 version. Then find the elements you like best and combine them.</p>
            <p>This isn't busywork—it's how you discover what your story really wants to be.</p>
        </div>
        <div class="content-block"><h3>Variation A</h3>${variationGrid('varA', 'Try a completely different tone or genre approach.')}</div>
        <div class="content-block"><h3>Variation B</h3>${variationGrid('varB', 'What if you changed the protagonist\'s core motivation?')}</div>
        <div class="content-block"><h3>Variation C</h3>${variationGrid('varC', 'The wild card—try something that feels almost wrong.')}</div>
        <div class="content-block"><h3>Your Final Story Circle</h3>${variationGrid('finalCircle', 'Combine the strongest elements from all versions into your definitive structure.')}</div>
        ${App.exportBar()}
        <div class="section-nav"><button class="btn btn-secondary" onclick="App.prevSection()">← Day 2</button><button class="btn btn-primary" onclick="App.nextSection()">Continue to Day 4 →</button></div>`;
    },

    fortypoints() {
        const storyPoints = [{num:1,title:'CHARACTER',act:'Act 1'},{num:2,title:'WANT',act:'Act 1'},{num:3,title:'GO',act:'Act 2'},{num:4,title:'ADAPT',act:'Act 2'},{num:5,title:'GET',act:'Act 3'},{num:6,title:'PAY',act:'Act 4'},{num:7,title:'RETURN',act:'Act 5'},{num:8,title:'CHANGED',act:'Act 5'}];

        function renderGuide(guide) {
            if (!guide) return '';
            let html = '<div class="scene-guide"><p class="guide-intro">' + guide.intro + '</p>';
            if (guide.details) html += '<p class="guide-details">' + guide.details + '</p>';
            if (guide.question) html += '<p class="guide-question"><strong>The Question:</strong> ' + guide.question + '</p>';
            if (guide.examples && guide.examples.length > 0) {
                html += '<div class="guide-examples"><strong>Examples:</strong><ul>';
                guide.examples.forEach(ex => { html += '<li><strong>' + ex[0] + ':</strong> ' + ex[1] + '</li>'; });
                html += '</ul></div>';
            }
            return html + '</div>';
        }

        let fortyHtml = '';
        storyPoints.forEach(point => {
            fortyHtml += `<div class="forty-point-group"><div class="forty-point-group-header" onclick="App.toggleFortyGroup(this)"><div class="forty-point-group-number">${point.num}</div><div class="forty-point-group-title">${point.title} <span style="opacity:0.7;font-weight:400;">· ${point.act}</span></div></div><div class="forty-point-scenes">`;
            for (let j = 1; j <= 5; j++) {
                const sceneNum = (point.num - 1) * 5 + j;
                const guide = BOX_GUIDES[point.num] ? BOX_GUIDES[point.num][j-1] : null;
                fortyHtml += `<div class="forty-point-scene"><label class="forty-point-scene-label">Scene ${sceneNum}${j > 1 ? ' <span class="connector-hint">THEREFORE or BUT</span>' : ''}</label>${renderGuide(guide)}<textarea data-field="forty_${point.num}_${j}" placeholder="Scene ${sceneNum}..."></textarea></div>`;
            }
            fortyHtml += '</div></div>';
        });

        return `<div class="section-header">
            <div class="section-phase">Day 4 · Phase 2</div>
            <h2 class="section-title">The 40 Points</h2>
            <p class="section-subtitle">Expand each story point into 5 connected scenes.</p>
        </div>
        <div class="content-block">
            <h3>The Method</h3>
            <p>Take each of your eight story points and write 5 sentences that make up the scenes of that sequence. Each sentence MUST be linked by either <strong>"therefore"</strong> or <strong>"but"</strong>.</p>
            <p>This is the secret sauce: "therefore" shows cause and effect, "but" introduces conflict. If scenes are connected by "and then," you don't have a story—you have a list.</p>
            <div class="tip-box"><div class="tip-box-title">🎬 The Rule</div><p>Scene A happens, <strong>THEREFORE</strong> Scene B happens. Scene B happens, <strong>BUT</strong> Scene C complicates things. Never "and then."</p></div>
        </div>
        <div class="content-block">
            <h3>About Page Count</h3>
            <p>These 40 points are beats you ought to be looking to hit—and sometimes more than one happens in the same scene. That said, if you give each of these points about 2 pages to breathe, you'll get an 80 page script.</p>
        </div>
        <div class="content-block">
            <h3>Reference Examples</h3>
            <p>We pull examples from Finding Nemo, The Lion King, Star Wars: A New Hope, Gladiator, Aladdin, Lord of the Rings: The Fellowship of the Ring, and others. If you're unfamiliar with one work, hopefully another resonates.</p>
        </div>
        ${fortyHtml}
        ${App.exportBar()}
        <div class="section-nav"><button class="btn btn-secondary" onclick="App.prevSection()">← Day 3</button><button class="btn btn-primary" onclick="App.nextSection()">Continue to Day 5 →</button></div>`;
    },

    fortyrevise() {
        const storyPoints = [{num:1,title:'CHARACTER',act:'Act 1'},{num:2,title:'WANT',act:'Act 1'},{num:3,title:'GO',act:'Act 2'},{num:4,title:'ADAPT',act:'Act 2'},{num:5,title:'GET',act:'Act 3'},{num:6,title:'PAY',act:'Act 4'},{num:7,title:'RETURN',act:'Act 5'},{num:8,title:'CHANGED',act:'Act 5'}];
        let fortyHtml = '';
        storyPoints.forEach(point => {
            fortyHtml += `<div class="forty-point-group"><div class="forty-point-group-header" onclick="App.toggleFortyGroup(this)"><div class="forty-point-group-number">${point.num}</div><div class="forty-point-group-title">${point.title} <span style="opacity:0.7;font-weight:400;">· ${point.act}</span></div></div><div class="forty-point-scenes">`;
            for (let j = 1; j <= 5; j++) {
                const sceneNum = (point.num - 1) * 5 + j;
                fortyHtml += `<div class="forty-point-scene"><label class="forty-point-scene-label">Scene ${sceneNum}${j > 1 ? ' <span class="connector-hint">THEREFORE or BUT</span>' : ''}</label><textarea data-field="fortyRevise_${point.num}_${j}" placeholder="Revised scene ${j}..."></textarea></div>`;
            }
            fortyHtml += '</div></div>';
        });

        return `<div class="section-header">
            <div class="section-phase">Day 5 · Phase 2</div>
            <h2 class="section-title">Revise Your 40 Points</h2>
            <p class="section-subtitle">Refine your scene structure—one version should be WILDLY different.</p>
        </div>
        <div class="content-block">
            <h3>Today's Work</h3>
            <p>Rewrite your 40 points. At least one version should be wildly different from yesterday. Then take the points you like most and combine them into the final structure below.</p>
            <p>Remember: every connection must be THEREFORE or BUT. Check each transition.</p>
        </div>
        ${fortyHtml}
        ${App.exportBar()}
        <div class="section-nav"><button class="btn btn-secondary" onclick="App.prevSection()">← Day 4</button><button class="btn btn-primary" onclick="App.nextSection()">Continue to Writing →</button></div>`;
    },

    scenes() {
        const perPage = App.SCENES_PER_PAGE;
        const page = App.currentScenePage;
        const startScene = (page - 1) * perPage + 1;
        const endScene = Math.min(page * perPage, 40);
        const totalPages = Math.ceil(40 / perPage);
        const script = Storage.get(App.currentScriptId);
        const fields = (script && script.fields) || {};

        // Paginator
        let paginatorHtml = '<div class="scene-paginator">';
        for (let p = 1; p <= totalPages; p++) {
            // Check if any scene in this page has content
            const pageStart = (p - 1) * perPage + 1;
            const pageEnd = Math.min(p * perPage, 40);
            let hasContent = false;
            for (let s = pageStart; s <= pageEnd; s++) {
                if (fields['scene_' + s] && fields['scene_' + s].trim()) { hasContent = true; break; }
            }
            paginatorHtml += `<button class="scene-page-btn${p === page ? ' active' : ''}${hasContent ? ' has-content' : ''}" onclick="App.goToScenePage(${p})">${pageStart}–${pageEnd}</button>`;
        }
        paginatorHtml += '</div>';

        let scenesHtml = '';
        for (let i = startScene; i <= endScene; i++) {
            const dayNum = i + 5;
            const storyPointNum = Math.ceil(i / 5);
            const storyPoint = CONTENT.storyPointNames[storyPointNum - 1];
            const sceneInGroup = ((i - 1) % 5) + 1;
            const fieldKey = 'fortyRevise_' + storyPointNum + '_' + sceneInGroup;
            const encouragement = CONTENT.encouragements[i - 1];

            scenesHtml += `<div class="scene-writing-card">
                <div class="scene-writing-header"><h4>Day ${dayNum}: Scene ${i}</h4><p>Story Point ${storyPointNum} (${storyPoint}) · Scene ${sceneInGroup} of 5</p></div>
                <div class="scene-writing-body">
                    <div class="scene-reference-box" data-reference="${fieldKey}"><div class="scene-reference-label">Your Scene Plan</div><div class="scene-reference-content">Complete Day 5 to see your scene outline here.</div></div>
                    <div class="encouragement-box">${encouragement}</div>
                    <textarea class="scene-textarea" data-field="scene_${i}" placeholder="Paste your scene pages here, or write notes about what you've written..."></textarea>
                </div>
            </div>`;
        }

        return `<div class="section-header">
            <div class="section-phase">Days 6–45 · Phase 3</div>
            <h2 class="section-title">Write Your Scenes</h2>
            <p class="section-subtitle">One scene per day. 40 days. A complete draft.</p>
        </div>
        <div class="content-block">
            <h3>The Daily Assignment</h3>
            <p>Take one of your 40 points and write it as a full scene. Use your screenwriting software of choice and paste your pages here to track progress.</p>
            <div class="tip-box"><div class="tip-box-title">📝 Recommended Tools</div><p>WriterDuet (free), Highland, Final Draft, or Google Docs for prose.</p></div>
        </div>
        ${paginatorHtml}
        ${scenesHtml}
        ${paginatorHtml}
        ${App.exportBar()}
        <div class="section-nav"><button class="btn btn-secondary" onclick="App.prevSection()">← Day 5</button><button class="btn btn-primary" onclick="App.nextSection()">Finish & Celebrate →</button></div>`;
    },

    celebrate() {
        return `<div class="section-header">
            <div class="section-phase">Day 46 · Completion</div>
            <h2 class="section-title">Celebrate!</h2>
            <p class="section-subtitle">You did the hard thing.</p>
        </div>
        <div class="celebration">
            <div class="celebration-icon">🎬</div>
            <h2>Congratulations!</h2>
            <p>You have a complete first draft. Take a moment to look at all the work you just did. Print it out, throw it in a drawer, and spare it the red pen for a few days—maybe even a week.</p>
            <div class="content-block" style="text-align:left;max-width:560px;margin:28px auto;">
                <h3>Write Yourself a Note</h3>
                <p class="input-hint">Document how proud you are. You're going to need this reminder on your rewrites.</p>
                <textarea class="large" data-field="celebrationNote" placeholder="Dear Future Me who is about to start rewrites..."></textarea>
            </div>
            <div class="content-block" style="text-align:left;max-width:560px;margin:28px auto;">
                <h3>What's Next</h3>
                <p>There are so many other writers—including you from just 45 days ago—who don't have this level of completed work. You did the hard thing, and that is an accomplishment no one can take away.</p>
                <p>Now? Rest. Then come back with red pens blazing.</p>
            </div>
        </div>
        ${App.exportBar()}
        <div class="section-nav"><button class="btn btn-secondary" onclick="App.prevSection()">← Scenes</button><button class="btn btn-secondary" onclick="window.print()">Print / PDF</button></div>`;
    },
};


/* ============================================
   MINIZIP: Self-contained ZIP builder
   No external dependencies needed
   ============================================ */
class MiniZip {
    constructor() { this.files = []; }

    addFile(name, content) {
        const encoder = new TextEncoder();
        const data = encoder.encode(content);
        this.files.push({ name: encoder.encode(name), data, nameStr: name });
    }

    toBlob(mimeType) {
        const files = this.files;
        const localHeaders = [];
        const centralHeaders = [];
        let offset = 0;

        // Build local file entries
        files.forEach(file => {
            const crc = this._crc32(file.data);
            const localHeader = this._buildLocalHeader(file.name, file.data, crc);
            localHeaders.push({ header: localHeader, data: file.data, offset });
            offset += localHeader.length + file.data.length;

            const centralHeader = this._buildCentralHeader(file.name, file.data, crc, localHeaders[localHeaders.length - 1].offset);
            centralHeaders.push(centralHeader);
        });

        // Calculate sizes
        const centralDirOffset = offset;
        let centralDirSize = 0;
        centralHeaders.forEach(h => centralDirSize += h.length);

        // Build end of central directory
        const eocd = this._buildEOCD(files.length, centralDirSize, centralDirOffset);

        // Combine all parts
        const totalSize = offset + centralDirSize + eocd.length;
        const result = new Uint8Array(totalSize);
        let pos = 0;

        // Local file entries
        localHeaders.forEach(entry => {
            result.set(entry.header, pos); pos += entry.header.length;
            result.set(entry.data, pos); pos += entry.data.length;
        });

        // Central directory
        centralHeaders.forEach(h => { result.set(h, pos); pos += h.length; });

        // EOCD
        result.set(eocd, pos);

        return new Blob([result], { type: mimeType || 'application/zip' });
    }

    _buildLocalHeader(name, data, crc) {
        const header = new Uint8Array(30 + name.length);
        const view = new DataView(header.buffer);
        view.setUint32(0, 0x04034b50, true);  // signature
        view.setUint16(4, 20, true);           // version needed
        view.setUint16(6, 0, true);            // flags
        view.setUint16(8, 0, true);            // compression: store
        view.setUint16(10, 0, true);           // mod time
        view.setUint16(12, 0, true);           // mod date
        view.setUint32(14, crc, true);         // crc32
        view.setUint32(18, data.length, true); // compressed size
        view.setUint32(22, data.length, true); // uncompressed size
        view.setUint16(26, name.length, true); // filename length
        view.setUint16(28, 0, true);           // extra field length
        header.set(name, 30);
        return header;
    }

    _buildCentralHeader(name, data, crc, localOffset) {
        const header = new Uint8Array(46 + name.length);
        const view = new DataView(header.buffer);
        view.setUint32(0, 0x02014b50, true);       // signature
        view.setUint16(4, 20, true);                // version made by
        view.setUint16(6, 20, true);                // version needed
        view.setUint16(8, 0, true);                 // flags
        view.setUint16(10, 0, true);                // compression: store
        view.setUint16(12, 0, true);                // mod time
        view.setUint16(14, 0, true);                // mod date
        view.setUint32(16, crc, true);              // crc32
        view.setUint32(20, data.length, true);      // compressed size
        view.setUint32(24, data.length, true);      // uncompressed size
        view.setUint16(28, name.length, true);      // filename length
        view.setUint16(30, 0, true);                // extra field length
        view.setUint16(32, 0, true);                // file comment length
        view.setUint16(34, 0, true);                // disk number start
        view.setUint16(36, 0, true);                // internal attrs
        view.setUint32(38, 0, true);                // external attrs
        view.setUint32(42, localOffset, true);      // local header offset
        header.set(name, 46);
        return header;
    }

    _buildEOCD(count, centralSize, centralOffset) {
        const eocd = new Uint8Array(22);
        const view = new DataView(eocd.buffer);
        view.setUint32(0, 0x06054b50, true);        // signature
        view.setUint16(4, 0, true);                  // disk number
        view.setUint16(6, 0, true);                  // central dir disk
        view.setUint16(8, count, true);              // entries on disk
        view.setUint16(10, count, true);             // total entries
        view.setUint32(12, centralSize, true);       // central dir size
        view.setUint32(16, centralOffset, true);     // central dir offset
        view.setUint16(20, 0, true);                 // comment length
        return eocd;
    }

    _crc32(data) {
        if (!MiniZip._crcTable) {
            const table = new Uint32Array(256);
            for (let i = 0; i < 256; i++) {
                let c = i;
                for (let j = 0; j < 8; j++) c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
                table[i] = c;
            }
            MiniZip._crcTable = table;
        }
        let crc = 0xFFFFFFFF;
        for (let i = 0; i < data.length; i++) crc = MiniZip._crcTable[(crc ^ data[i]) & 0xFF] ^ (crc >>> 8);
        return (crc ^ 0xFFFFFFFF) >>> 0;
    }
}


/* ============================================
   BOOT
   ============================================ */
document.addEventListener('DOMContentLoaded', () => App.init());
</script>

</body>
</html>
